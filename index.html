<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp ¬∑ Pro üá∏üáª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        /* Alerta de Perfil */
        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; position: sticky; top: 0; z-index: 10;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}
        .cat-fav{background: #ffeaa7 !important; color: #d63031 !important;}

        .perfil-img-cont{text-align:center; position:relative; width:80px; margin:auto}
        .foto-perfil{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); background:#eee; cursor:pointer}
        .vendedor-link {font-size: 11px; color: var(--azul); text-decoration: underline; cursor: pointer; margin-top: 5px; display: flex; align-items: center; gap: 4px;}
        .header-catalogo{grid-column: 1 / -1; background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--azul); margin-bottom: 10px;}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative; transition: 0.2s;}
        .foto{height:160px; width:100%; object-fit:cover; background:#eee}
        
        .btn-fav {position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--mut);}
        .btn-fav.active {color: #ff4757;}
        .btn-share-post {position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--azul);}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tags-cont{display:flex; gap:4px; flex-wrap:wrap; margin-bottom:4px}
        .tag{font-size:9px; border:1px solid var(--azul); color:var(--azul); padding:1px 6px; border-radius:4px; font-weight: bold;}
        .tag-envio{font-size:9px; background:var(--azul); color:white; padding:1px 6px; border-radius:4px; font-weight: bold;}
        
        .titulo{font-weight:600; font-size:15px; line-height: 1.2; margin-top: 4px;}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .loc{font-size:10px; color:var(--mut); margin-top: 5px;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-vendido-accion{background:var(--azul); color:white; border:none; padding:8px; border-radius:8px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:8px}
        .btn-eliminar-accion{background:none; color:var(--rojo); border:none; padding:5px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:5px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        
        #modal, #modalPerfil{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:99; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--fondo); color:var(--txt); font-family:inherit}
        
        .sidebar{position:fixed; top:0; right:-280px; width:280px; height:100%; background:var(--card); box-shadow:-5px 0 15px rgba(0,0,0,0.3); z-index:100; transition:0.3s; padding:20px; box-sizing:border-box}
        .sidebar.active{right:0}
        .btn-menu{position:absolute; right:15px; top:18px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--azul)}
        .sold-overlay{position:absolute; top:0; left:0; width:100%; height:160px; background:rgba(0,0,0,0.7); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:1}
        .seccion-titulo{grid-column: 1 / -1; font-size: 14px; font-weight: bold; color: var(--mut); margin-top: 15px; border-bottom: 1px solid var(--b); padding-bottom: 5px;}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    ‚ö†Ô∏è <strong>Perfil Incompleto:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; text-decoration: underline;">Configura tu perfil</a> para vender.
</div>

<header>
    <button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div class="sub">Compra y vende entre salvadore√±os</div>

    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="¬øQu√© buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M√°x" oninput="filtrar()">
        <button class="btn-theme" style="background:none; border:none; cursor:pointer; color:var(--azul)" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()">
            <option value="">üìç Todo El Salvador</option>
        </select>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
        <button class="cat cat-fav" onclick="verFavoritos(this)"><i class="fa-solid fa-heart"></i> Favoritos</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user-circle"></i> Mi Perfil</button>
    </div>
</header>
   <div style="font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 20px auto; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #ffffff;">
  
  <div style="max-height: 450px; overflow-y: auto; scrollbar-width: thin;">
    
    <details style="border-bottom: 1px solid #eee;" open>
      <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #f8f9fa; color: #333; display: flex; align-items: center; list-style: none;">
        <span style="margin-right: 12px; font-size: 1.2em;">üìú</span> T√©rminos y Condiciones de CheroMarketApp
      </summary>
      <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; border-top: 1px solid #eee;">
        <h4 style="margin-top: 0;">1. Aceptaci√≥n de los T√©rminos</h4>
        <p>Al descargar, instalar o usar CheroMarketApp, el usuario acepta cumplir con estos t√©rminos. Si no est√° de acuerdo, debe abstenerse de utilizar la plataforma.</p>
        
        <h4>2. Descripci√≥n del Servicio</h4>
        <p>CheroMarketApp es una plataforma intermediaria que permite a los usuarios publicar anuncios de productos o servicios para su compra y venta en el territorio de El Salvador. La aplicaci√≥n no es due√±a, no vende, ni garantiza los art√≠culos publicados por terceros.</p>
        
        <h4>3. Registro y Seguridad</h4>
        <ul>
          <li>Solo podr√°n registrarse personas mayores de 18 a√±os.</li>
          <li>El usuario es responsable de mantener la confidencialidad de sus credenciales de acceso.</li>
          <li>Cualquier actividad realizada bajo la cuenta del usuario ser√° su responsabilidad exclusiva.</li>
        </ul>
        
        <h4>4. Reglas de Publicaci√≥n y Uso</h4>
        <p>Queda estrictamente prohibido publicar art√≠culos ilegales seg√∫n las leyes de la Rep√∫blica de El Salvador, contenido ofensivo o productos falsificados.</p>
        
        <h4>5. Responsabilidad en las Transacciones</h4>
        <p>CheroMarketApp no participa en la negociaci√≥n ni entrega. El contacto y la transacci√≥n financiera ocurren exclusivamente entre comprador y vendedor.</p>
        
        <h4>6. Privacidad de Datos</h4>
        <p>El uso de datos personales se rige por nuestra Pol√≠tica de Privacidad, cumpliendo con los est√°ndares de protecci√≥n de datos en el pa√≠s.</p>
        
        <h4>7. Suspensi√≥n y Terminaci√≥n</h4>
        <p>Nos reservamos el derecho de suspender cuentas que infrinjan estos t√©rminos sin previo aviso.</p>
        
        <h4>8. Modificaciones</h4>
        <p>Podemos actualizar estos t√©rminos en cualquier momento notificando cambios significativos.</p>
        
        <h4>9. Jurisdicci√≥n y Ley Aplicable</h4>
        <p>Leyes de la Rep√∫blica de El Salvador. Disputas ante tribunales de San Salvador.</p>
      </div>
    </details>

    <details style="border-bottom: 1px solid #eee;">
      <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #f8f9fa; color: #333; display: flex; align-items: center; list-style: none;">
        <span style="margin-right: 12px; font-size: 1.2em;">‚öñÔ∏è</span> Pol√≠tica de Privacidad
      </summary>
      <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; border-top: 1px solid #eee;">
        <p><em>√öltima actualizaci√≥n: 22 de enero de 2026</em></p>
        <h4>1. Informaci√≥n que Recopilamos</h4>
        <p>Recolectamos informaci√≥n de registro (nombre, email, tel√©fono), contenido del usuario (fotos, mensajes), datos de ubicaci√≥n y del dispositivo.</p>
        
        <h4>2. Uso de la Informaci√≥n</h4>
        <p>Para facilitar anuncios, personalizar tu experiencia en El Salvador, enviar notificaciones y mantener la seguridad.</p>
        
        <h4>3. C√≥mo Compartimos tu Informaci√≥n</h4>
        <p>Tu nombre y tel√©fono pueden ser visibles en anuncios. No vendemos tus datos a terceros con fines publicitarios.</p>
        
        <h4>4. Tus Derechos</h4>
        <p>Puedes editar tu perfil, solicitar la eliminaci√≥n de tu cuenta o gestionar permisos de ubicaci√≥n y c√°mara desde tu dispositivo.</p>
      </div>
    </details>

    <details style="border-bottom: 1px solid #eee;">
      <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #e8f4fd; color: #0056b3; display: flex; align-items: center; list-style: none;">
        <span style="margin-right: 12px; font-size: 1.2em;">üõ°Ô∏è</span> Gu√≠a de Seguridad para Cheros
      </summary>
      <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; background-color: #fafcfe;">
        <p><strong>ü§ù Negocios Seguros:</strong> Re√∫nete en centros comerciales o gasolineras con c√°maras. Ve acompa√±ado y de d√≠a.</p>
        <p><strong>üí∞ Pagos:</strong> <strong>NUNCA</strong> env√≠es dinero por adelantado. Verifica el saldo disponible en tu banco antes de entregar el producto.</p>
        <p><strong>üì¶ Verificaci√≥n:</strong> Prueba los electr√≥nicos y revisa documentos de veh√≠culos en el VMT antes de pagar.</p>
      </div>
    </details>

  </div>

  <div style="padding: 20px; text-align: center; background-color: #ffffff; border-top: 1px solid #eee;">
    <button type="button" onclick="alert('Gracias por aceptar los t√©rminos de CheroMarketApp')" style="width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); transition: background 0.3s;">
      Acepto todos los T√©rminos y Condiciones
    </button>
    <p style="font-size: 11px; color: #999; margin-top: 10px;">Al hacer clic, confirmas que has le√≠do y comprendido los documentos legales de CheroMarketApp.</p>
  </div>

</div>
     
<div id="sidebar" class="sidebar">
    <button style="width:100%; padding:10px; margin-bottom:20px" onclick="toggleMenu()">Cerrar Men√∫</button>
    <button onclick="compartirApp()" style="width:100%; background:var(--azul); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom: 15px;">
        <i class="fa-solid fa-share-nodes"></i> Recomendar App
    </button>
    <p><strong>Seguridad:</strong> Re√∫nete en lugares p√∫blicos.</p>
    <hr>
    <p>Versi√≥n 2.0 Pro ¬∑ 2026</p>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="modal">
    <div class="modal-content">
        <h3>Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes?">
        <textarea id="descripcion" placeholder="Detalles del producto..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $" style="flex:1">
            <select id="estado" style="flex:1">
                <option value="Nuevo">Nuevo</option>
                <option value="Usado">Usado</option>
            </select>
        </div>

        <label style="font-size:12px; font-weight:bold; color:var(--azul)">Tipo de Entrega:</label>
        <select id="opcionEnvio">
            <option value="Solo entrega local">Solo entrega local</option>
            <option value="Env√≠os a todo el pa√≠s">Env√≠os a todo el pa√≠s</option>
        </select>

        <div style="border:1px dashed var(--azul); padding:10px; border-radius:8px; text-align:center">
            <input type="file" id="fotoFile" accept="image/*" style="font-size:12px; width:100%">
            <img id="imgPrevia" style="width:100%; height:120px; object-fit:cover; display:none; margin-top:10px; border-radius:5px">
        </div>
        <select id="categoria">
            <option>Tecnolog√≠a</option><option>Ropa</option><option>Comida</option><option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()"><option value="">Departamento</option></select>
        <select id="muni"><option value="">Municipio</option></select>
        
        <button onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil de Vendedor</h3>
        <div class="perfil-img-cont" onclick="document.getElementById('fotoPerfilFile').click()">
            <img id="imgPerfilPrevia" class="foto-perfil" src="https://via.placeholder.com/80">
            <input type="file" id="fotoPerfilFile" accept="image/*" style="display:none">
        </div>
        <input id="perfilNombre" placeholder="Tu nombre o negocio">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77771234)">
        <button onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Guardar Perfil</button>
        <button onclick="verMisAnuncios()" style="background:var(--azul); color:white; padding:10px; border:none; border-radius:8px;">Mis Anuncios</button>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none">Cerrar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const svData = {
"Ahuachap√°n": ["Ahuachap√°n", "Jujutla", "Atiquizaya", "Concepci√≥n de Ataco", "El Refugio", "Guaymango", "Apaneca", "San Francisco Men√©ndez", "San Lorenzo", "San Pedro Puxtla", "Tur√≠n"],
"Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Metap√°n", "San Antonio Pajonal", "San Sebasti√°n Salitrillo", "Santa Rosa Guachipil√≠n", "Santiago de la Frontera", "Texistepeque"],
"Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juay√∫a", "Nahuizalco", "Nahulingo", "Salcoatit√°n", "San Antonio del Monte", "San Juli√°n", "Santa Catarina Masahuat", "Santa Isabel Ishuat√°n", "Santo Domingo de Guzm√°n", "Sonzacate"],
"Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "Cital√°", "Comalapa", "Concepci√≥n Quezaltepeque", "Dulce Nombre de Mar√≠a", "El Carrizal", "El Para√≠so", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de Jes√∫s", "Nueva Concepci√≥n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Moraz√°n", "San Ignacio", "San Isidro Labrador", "San Jos√© Cancasque", "San Jos√© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
"La Libertad": ["Santa Tecla", "Antiguo Cuscatl√°n", "Chiltiup√°n", "Ciudad Arce", "Col√≥n", "Comasagua", "Huiz√∫car", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatl√°n", "Quezaltepeque", "San Juan Opico", "Sacacoyo", "San Jos√© Villanueva", "San Mat√≠as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
"San Salvador": ["San Salvador", "Ayutuxtepeque", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Mart√≠n", "Santiago Texacuangos", "Santo Tom√°s", "Soyapango", "Tonacatepeque", "Delgado", "Cuscatancingo", "Ilopango", "Guazapa", "Aguilares", "El Paisnal"],
"Cuscatl√°n": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepci√≥n", "San Bartolom√© Perulap√≠a", "San Crist√≥bal", "San Jos√© Guayabal", "San Rafael Cedros", "San Ram√≥n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo", "San Pedro Perulap√°n"],
"La Paz": ["Zacatecoluca", "Cuyultit√°n", "El Rosario", "Jerusal√©n", "Mercedes La Ceiba", "Olocuilta", "Para√≠so de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Marcelino", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa Mar√≠a Ostuma", "Santiago Nonualco", "Tapalhuac√°n"],
"Caba√±as": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Victoria"],
"San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebasti√°n", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetit√°n", "Verapaz"],
"Usulut√°n": ["Usulut√°n", "Alegr√≠a", "Berl√≠n", "California", "Concepci√≥n Batres", "El Triunfo", "Ereguayqu√≠n", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuar√°n", "Mercedes Uma√±a", "Nueva Granada", "Ozatl√°n", "Puerto El Triunfo", "San Agust√≠n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa Mar√≠a", "Santiago de Mar√≠a", "Tecap√°n"],
"San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacar√°n", "Gualococti", "Guatajiagua", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Ed√©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],
"Moraz√°n": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepci√≥n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Loloquique", "Meanguera", "Osicala", "Perqu√≠n", "San Carlos", "San Fernando", "San Isidro", "San Sim√≥n", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiqu√≠n"],
"La Uni√≥n": ["La Uni√≥n", "Conchagua", "El Carmen", "Intipuc√°", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polor√≥s", "San Alejo", "San Jos√©", "Santa Rosa de Lima", "Yayantique", "Yucuaiqu√≠n", "Lislique", "Anamor√≥s", "Concepci√≥n de Oriente", "El Sauce"]
};

let productos = [];
let favoritos = JSON.parse(localStorage.getItem("mis_favoritos")) || [];
const state = { categoria: "Todos" };
const MI_ID = localStorage.getItem("mi_id_usuario") || "u_" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("mi_id_usuario", MI_ID);

let imagenBase64 = "";
let fotoPerfilBase64 = localStorage.getItem("p_foto") || "";

window.compartirPost = async (titulo, precio, muni) => {
    const texto = `¬°Mira lo que encontr√© en CheroMarketApp! üá∏üáª\n\nüì¶ ${titulo}\nüí∞ Precio: $${precio}\nüìç Ubicaci√≥n: ${muni}`;
    if (navigator.share) {
        try { await navigator.share({ title: 'CheroMarketApp', text: texto, url: window.location.href }); } catch (err) {}
    } else {
        navigator.clipboard.writeText(`${texto}\n${window.location.href}`);
        alert("¬°Copiado!");
    }
};

window.compartirApp = async () => {
    const texto = "Te recomiendo CheroMarketApp üá∏üáª para comprar y vender f√°cil.";
    if (navigator.share) {
        try { await navigator.share({ title: 'CheroMarketApp', text: texto, url: window.location.href }); } catch (err) {}
    } else {
        navigator.clipboard.writeText(window.location.href);
        alert("Link copiado.");
    }
};

// --- FOTOS ---
document.getElementById('fotoFile').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX = 800;
            let w = img.width, h = img.height;
            if (w > MAX) { h *= MAX/w; w = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            imagenBase64 = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('imgPrevia').src = imagenBase64;
            document.getElementById('imgPrevia').style.display = "block";
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
};

document.getElementById('fotoPerfilFile').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 200;
            canvas.getContext('2d').drawImage(img, 0, 0, 200, 200);
            fotoPerfilBase64 = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64;
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
};

// --- PERFIL ---
function verificarPerfil() {
    const n = localStorage.getItem("p_nombre"), t = localStorage.getItem("p_tel");
    document.getElementById("bannerPerfil").style.display = (n && t) ? "none" : "block";
    return (n && t);
}
window.abrirPerfil = () => {
    document.getElementById('perfilNombre').value = localStorage.getItem("p_nombre") || "";
    document.getElementById('perfilTelefono').value = localStorage.getItem("p_tel") || "";
    document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64 || "https://via.placeholder.com/80";
    document.getElementById('modalPerfil').style.display = "block";
};
window.guardarPerfil = () => {
    localStorage.setItem("p_nombre", document.getElementById('perfilNombre').value);
    localStorage.setItem("p_tel", document.getElementById('perfilTelefono').value);
    localStorage.setItem("p_foto", fotoPerfilBase64);
    verificarPerfil(); document.getElementById('modalPerfil').style.display = "none";
};
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

// --- CORE ---
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
window.abrir = () => !verificarPerfil() ? abrirPerfil() : document.getElementById('modal').style.display = "block";
window.cerrar = () => document.getElementById('modal').style.display = "none";

window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

window.publicar = async () => {
    const t = document.getElementById('titulo').value, p = document.getElementById('precio').value;
    if(!t || !p || !imagenBase64) return alert("Faltan datos.");
    await addDoc(collection(db,"productos"), {
        titulo: t, descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2), foto: imagenBase64,
        categoria: document.getElementById('categoria').value,
        entrega: document.getElementById('opcionEnvio').value, // NUEVO
        depto: document.getElementById('depto').value, muni: document.getElementById('muni').value,
        vendedor: localStorage.getItem("p_nombre"), telefono: localStorage.getItem("p_tel"),
        fotoPerfilVendedor: fotoPerfilBase64,
        creado: Date.now(), duenoId: MI_ID, vendido: false, oculto: false
    });
    location.reload();
};

window.marcarVendido = async (id) => {
    if(confirm("¬øVendido?")) { await updateDoc(doc(db,"productos",id), {vendido:true}); cargar(); }
};

window.eliminar = async (id) => {
    if(confirm("¬øEliminar anuncio?")) { await updateDoc(doc(db,"productos",id), {oculto:true}); cargar(); }
};

window.filtrar = () => {
    const txt = document.getElementById('buscar').value.toLowerCase();
    const dep = document.getElementById('filtroDepto').value;
    const pMax = parseFloat(document.getElementById('precioMax').value) || Infinity;
    const filtrados = productos.filter(p => {
        const cTxt = p.titulo.toLowerCase().includes(txt) || p.muni.toLowerCase().includes(txt);
        const cDep = dep === "" || p.depto === dep;
        const cPre = parseFloat(p.precio) <= pMax;
        const cCat = state.categoria === "Todos" ? true : (state.categoria === "Favoritos" ? favoritos.includes(p.id) : p.categoria === state.categoria);
        return cTxt && cDep && cPre && cCat;
    });
    render(filtrados);
};

window.setCat = (c, b) => {
    state.categoria = c;
    document.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

window.toggleFavorito = (id) => {
    favoritos.includes(id) ? favoritos = favoritos.filter(f => f !== id) : favoritos.push(id);
    localStorage.setItem("mis_favoritos", JSON.stringify(favoritos));
    render(productos);
};

window.verFavoritos = (b) => setCat("Favoritos", b);

window.verCatalogo = (idVendedor, nombreVendedor, fotoVendedor) => {
    const filtrados = productos.filter(p => p.duenoId === idVendedor);
    const feed = document.getElementById('feed');
    feed.innerHTML = `<div class="header-catalogo">
        <img src="${fotoVendedor || 'https://via.placeholder.com/80'}" class="foto-perfil">
        <h2>${nombreVendedor}</h2>
        <button onclick="cargar()" style="background:var(--azul); color:white; border:none; padding:8px 15px; border-radius:20px;">Ver todo el Market</button>
    </div>`;
    filtrados.forEach(p => feed.innerHTML += crearCard(p));
    window.scrollTo(0,0);
};

window.verMisAnuncios = () => {
    cerrarPerfil();
    verCatalogo(MI_ID, localStorage.getItem("p_nombre"), fotoPerfilBase64);
};

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    const disp = lista.filter(p => !p.vendido);
    const vend = lista.filter(p => p.vendido);
    disp.forEach(p => feed.innerHTML += crearCard(p));
    if(vend.length > 0) {
        feed.innerHTML += `<div class="seccion-titulo">YA VENDIDOS (${vend.length})</div>`;
        vend.forEach(p => feed.innerHTML += crearCard(p));
    }
}

function crearCard(p) {
    const esFav = favoritos.includes(p.id);
    const esMio = p.duenoId === MI_ID;
    const esEnvioNacional = p.entrega === "Env√≠os a todo el pa√≠s";

    return `
        <div class="card" style="${p.vendido ? 'opacity:0.6' : ''}">
            <button class="btn-fav ${esFav?'active':''}" onclick="toggleFavorito('${p.id}')"><i class="fa-solid fa-heart"></i></button>
            <button class="btn-share-post" onclick="compartirPost('${p.titulo}', '${p.precio}', '${p.muni}')"><i class="fa-solid fa-share-nodes"></i></button>
            ${p.vendido ? '<div class="sold-overlay">VENDIDO</div>' : ''}
            <img class="foto" src="${p.foto}">
            <div class="info">
                <div class="tags-cont">
                    <span class="tag">${p.categoria}</span>
                    <span class="tag-envio" style="background:${esEnvioNacional?'var(--azul)':'var(--mut)'}">
                        <i class="fa-solid ${esEnvioNacional?'fa-truck-fast':'fa-handshake'}"></i> ${p.entrega || 'Entrega Local'}
                    </span>
                </div>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="loc">${p.muni}, ${p.depto}</div>
                <div class="vendedor-link" onclick="verCatalogo('${p.duenoId}', '${p.vendedor}', '${p.fotoPerfilVendedor}')">
                    <i class="fa-solid fa-store"></i> Ver tienda
                </div>
                ${!p.vendido ? `<a class="btn-wa" target="_blank" href="https://wa.me/503${p.telefono}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>` : ''}
                ${esMio && !p.vendido ? `<button class="btn-vendido-accion" onclick="marcarVendido('${p.id}')">Vendido</button>` : ''}
                ${esMio ? `<button class="btn-eliminar-accion" onclick="eliminar('${p.id}')">Eliminar</button>` : ''}
            </div>
        </div>`;
}

// Init
const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});
verificarPerfil();
cargar();
</script>
</body>
</html>
