<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp 췅 Pro 游젏릖</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        /* Alerta de Perfil */
        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; position: sticky; top: 0; z-index: 10;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}
        .cat-fav{background: #ffeaa7 !important; color: #d63031 !important;}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative; transition: 0.2s;}
        .foto{height:160px; width:100%; object-fit:cover; background:#eee}
        
        .btn-fav {position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--mut);}
        .btn-fav.active {color: #ff4757;}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tag{font-size:9px; border:1px solid var(--azul); color:var(--azul); padding:1px 6px; border-radius:4px; font-weight: bold;}
        .titulo{font-weight:600; font-size:15px; line-height: 1.2; margin-top: 4px;}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .desc{font-size:11px; color:var(--mut); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
        .loc{font-size:10px; color:var(--mut); margin-top: 5px;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-vendido-accion{background:var(--azul); color:white; border:none; padding:8px; border-radius:8px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:8px}
        .btn-eliminar-accion{background:none; color:var(--rojo); border:none; padding:5px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:5px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        
        #modal, #modalPerfil{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:99; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--fondo); color:var(--txt); font-family:inherit}
        
        .sidebar{position:fixed; top:0; right:-280px; width:280px; height:100%; background:var(--card); box-shadow:-5px 0 15px rgba(0,0,0,0.3); z-index:100; transition:0.3s; padding:20px; box-sizing:border-box}
        .sidebar.active{right:0}
        .btn-menu{position:absolute; right:15px; top:18px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--azul)}
        .sold-overlay{position:absolute; top:0; left:0; width:100%; height:160px; background:rgba(0,0,0,0.7); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:1}
        .seccion-titulo{grid-column: 1 / -1; font-size: 14px; font-weight: bold; color: var(--mut); margin-top: 15px; border-bottom: 1px solid var(--b); padding-bottom: 5px;}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    丘멆잺 <strong>Perfil Incompleto:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; text-decoration: underline;">Configura tu WhatsApp</a> para vender.
</div>

<header>
    <button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    <h1>游젏릖 CheroMarketApp</h1>
    <div class="sub">Compra y vende entre salvadore침os</div>

    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="쯈u칠 buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M치x" oninput="filtrar()">
        <button class="btn-theme" style="background:none; border:none; cursor:pointer; color:var(--azul)" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()">
            <option value="">游늸 Todo El Salvador</option>
        </select>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
        <button class="cat" onclick="setCat('Tecnolog칤a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog칤a</button>
        <button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
        <button class="cat cat-fav" onclick="verFavoritos(this)"><i class="fa-solid fa-heart"></i> Favoritos</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user-circle"></i> Mi Perfil</button>
    </div>
</header>

<div id="sidebar" class="sidebar">
    <button style="width:100%; padding:10px; margin-bottom:20px" onclick="toggleMenu()">Cerrar Men칰</button>
    <h3>Men칰 Principal</h3>
    <button onclick="alert('Link copiado!')" style="width:100%; background:var(--azul); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom: 15px;">
        <i class="fa-solid fa-share-nodes"></i> Recomendar App
    </button>
    <div style="font-size: 13px; color: var(--mut)">
        <p><strong>Seguridad:</strong> No env칤es dinero sin ver el producto.</p>
        <hr>
        <p>Versi칩n 2.0 Pro 췅 2026</p>
    </div>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="modal">
    <div class="modal-content">
        <h3>Nuevo Anuncio</h3>
        <input id="titulo" placeholder="쯈u칠 vendes?">
        <textarea id="descripcion" placeholder="Detalles del producto..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $" style="flex:1">
            <select id="estado" style="flex:1">
                <option value="Nuevo">Nuevo</option>
                <option value="Usado">Usado</option>
            </select>
        </div>
        <div style="border:1px dashed var(--azul); padding:10px; border-radius:8px; text-align:center">
            <input type="file" id="fotoFile" accept="image/*" style="font-size:12px; width:100%">
            <img id="imgPrevia" style="width:100%; height:120px; object-fit:cover; display:none; margin-top:10px; border-radius:5px">
        </div>
        <select id="categoria">
            <option>Tecnolog칤a</option><option>Ropa</option><option>Comida</option><option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()"><option value="">Departamento</option></select>
        <select id="muni"><option value="">Municipio</option></select>
        <button onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Registro de Vendedor</h3>
        <input id="perfilNombre" placeholder="Tu nombre">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77771234)">
        <button onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Guardar Perfil</button>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none">Cerrar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const svData = {
    "San Salvador": ["San Salvador", "Mejicanos", "Soyapango", "Santa Tecla", "Ilopango"],
    "La Libertad": ["Santa Tecla", "Zaragoza", "Antiguo Cuscatl치n", "Col칩n"],
    "Santa Ana": ["Santa Ana", "Metap치n", "Chalchuapa"],
    "San Miguel": ["San Miguel", "Chinameca", "El Tr치nsito"]
    // ... los dem치s se cargan din치micamente si los incluyes en la lista completa
};

let productos = [];
let favoritos = JSON.parse(localStorage.getItem("mis_favoritos")) || [];
const state = { categoria: "Todos" };
const MI_ID = localStorage.getItem("mi_id_usuario") || "u_" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("mi_id_usuario", MI_ID);

let imagenBase64 = "";
document.getElementById('fotoFile').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX = 800;
            let w = img.width, h = img.height;
            if (w > MAX) { h *= MAX/w; w = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            imagenBase64 = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('imgPrevia').src = imagenBase64;
            document.getElementById('imgPrevia').style.display = "block";
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
};

// --- PERFIL ---
function verificarPerfil() {
    const n = localStorage.getItem("p_nombre"), t = localStorage.getItem("p_tel");
    document.getElementById("bannerPerfil").style.display = (n && t) ? "none" : "block";
    return (n && t);
}
window.abrirPerfil = () => {
    document.getElementById('perfilNombre').value = localStorage.getItem("p_nombre") || "";
    document.getElementById('perfilTelefono').value = localStorage.getItem("p_tel") || "";
    document.getElementById('modalPerfil').style.display = "block";
};
window.guardarPerfil = () => {
    localStorage.setItem("p_nombre", document.getElementById('perfilNombre').value);
    localStorage.setItem("p_tel", document.getElementById('perfilTelefono').value);
    verificarPerfil(); document.getElementById('modalPerfil').style.display = "none";
};
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

// --- CORE ---
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
window.abrir = () => !verificarPerfil() ? abrirPerfil() : document.getElementById('modal').style.display = "block";
window.cerrar = () => document.getElementById('modal').style.display = "none";

window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

window.publicar = async () => {
    const t = document.getElementById('titulo').value, p = document.getElementById('precio').value;
    if(!t || !p || !imagenBase64) return alert("Faltan datos.");
    await addDoc(collection(db,"productos"), {
        titulo: t, descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2), foto: imagenBase64,
        categoria: document.getElementById('categoria').value,
        depto: document.getElementById('depto').value, muni: document.getElementById('muni').value,
        vendedor: localStorage.getItem("p_nombre"), telefono: localStorage.getItem("p_tel"),
        creado: Date.now(), duenoId: MI_ID, vendido: false, oculto: false
    });
    location.reload();
};

window.marcarVendido = async (id) => {
    if(confirm("쯌endido?")) { await updateDoc(doc(db,"productos",id), {vendido:true}); cargar(); }
};

window.eliminar = async (id) => {
    if(confirm("쮼liminar anuncio?")) { await updateDoc(doc(db,"productos",id), {oculto:true}); cargar(); }
};

window.filtrar = () => {
    const txt = document.getElementById('buscar').value.toLowerCase();
    const dep = document.getElementById('filtroDepto').value;
    const pMax = parseFloat(document.getElementById('precioMax').value) || Infinity;
    const filtrados = productos.filter(p => {
        const cTxt = p.titulo.toLowerCase().includes(txt) || p.muni.toLowerCase().includes(txt);
        const cDep = dep === "" || p.depto === dep;
        const cPre = parseFloat(p.precio) <= pMax;
        const cCat = state.categoria === "Todos" ? true : (state.categoria === "Favoritos" ? favoritos.includes(p.id) : p.categoria === state.categoria);
        return cTxt && cDep && cPre && cCat;
    });
    render(filtrados);
};

window.setCat = (c, b) => {
    state.categoria = c;
    document.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

window.toggleFavorito = (id) => {
    favoritos.includes(id) ? favoritos = favoritos.filter(f => f !== id) : favoritos.push(id);
    localStorage.setItem("mis_favoritos", JSON.stringify(favoritos));
    render(productos);
};

window.verFavoritos = (b) => setCat("Favoritos", b);

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    const disp = lista.filter(p => !p.vendido);
    const vend = lista.filter(p => p.vendido);

    disp.forEach(p => feed.innerHTML += crearCard(p));
    if(vend.length > 0) {
        feed.innerHTML += `<div class="seccion-titulo">YA VENDIDOS (${vend.length})</div>`;
        vend.forEach(p => feed.innerHTML += crearCard(p));
    }
}

function crearCard(p) {
    const esFav = favoritos.includes(p.id);
    const esMio = p.duenoId === MI_ID;
    return `
        <div class="card" style="${p.vendido ? 'opacity:0.6' : ''}">
            <button class="btn-fav ${esFav?'active':''}" onclick="toggleFavorito('${p.id}')"><i class="fa-solid fa-heart"></i></button>
            ${p.vendido ? '<div class="sold-overlay">VENDIDO</div>' : ''}
            <img class="foto" src="${p.foto}">
            <div class="info">
                <span class="tag">${p.categoria}</span>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="loc">${p.muni}, ${p.depto}</div>
                ${!p.vendido ? `<a class="btn-wa" target="_blank" href="https://wa.me/503${p.telefono}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>` : ''}
                ${esMio && !p.vendido ? `<button class="btn-vendido-accion" onclick="marcarVendido('${p.id}')">Vendido</button>` : ''}
                ${esMio ? `<button class="btn-eliminar-accion" onclick="eliminar('${p.id}')">Eliminar</button>` : ''}
            </div>
        </div>`;
}

// Init departamentos
const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});

verificarPerfil();
cargar();
</script>
</body>
</html>
