<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp Pro üá∏üáª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        
        /* Pantalla de Inicio / Registro */
        #pantallaAuth {
            position: fixed; inset: 0; background: var(--azul); z-index: 2000;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .auth-card { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; color: var(--txt); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .auth-card input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--b); border-radius: 8px; box-sizing: border-box; }
        .btn-principal { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }

        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 20px;}
        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        
        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap;}
        .cat.active{background:var(--azul); color:white}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; position:relative;}
        .foto-principal{height:160px; width:100%; object-fit:cover; cursor: pointer;}
        
        .info{padding:10px; display:flex; flex-direction:column; gap:4px;}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .btn-wa{background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:5px; margin-top:5px}
        
        #modal, #modalPerfil, #visorFotoInterno{position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; z-index:1500; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:400px; margin:20px auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        .foto-perfil-v{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); margin: auto; display: block; background: #eee;}
        .sold-overlay{position:absolute; top:0; left:0; width:100%; height:160px; background:rgba(0,0,0,0.7); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:1}
    </style>
</head>
<body data-theme="light">

<div id="pantallaAuth">
    <div class="auth-card">
        <h2 style="margin:0">CheroMarket üá∏üáª</h2>
        <p style="font-size:12px; color:var(--mut); margin-bottom:15px">Compra y vende de forma segura</p>
        <input type="email" id="correoAuth" placeholder="Correo electr√≥nico">
        <input type="password" id="claveAuth" placeholder="Contrase√±a">
        <button class="btn-principal" style="background:var(--azul); color:white" onclick="entrar()">Entrar</button>
        <button class="btn-principal" style="background:var(--verde); color:white" onclick="crearCuenta()">Crear Cuenta</button>
    </div>
</div>

<div id="bannerPerfil" class="alerta-perfil">
    ‚ö†Ô∏è <strong>Perfil Incompleto:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; font-weight:bold;">Configura tu perfil</a> para vender.
</div>

<header>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div id="statusHeader" style="font-size: 11px; margin-bottom:5px"></div>

    <div class="buscador-cont">
        <input id="buscar" class="buscador" placeholder="¬øQu√© buscas hoy?" oninput="filtrar()">
        <button onclick="toggleTheme()" style="background:none; border:none; color:var(--azul); cursor:pointer"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)">Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)">Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)">Ropa</button>
        <button class="cat" style="background:var(--naranja); color:white" onclick="abrirPerfil()">Mi Perfil</button>
        <button class="cat" style="background:var(--rojo); color:white" onclick="salir()">Salir</button>
    </div>
</header>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="modal">
    <div class="modal-content">
        <h3>¬øQu√© vas a vender?</h3>
        <input id="titulo" placeholder="Nombre del producto">
        <textarea id="descripcion" placeholder="Descripci√≥n detallada..." style="padding:10px; border-radius:8px; border:1px solid var(--b)"></textarea>
        <input id="precio" type="number" placeholder="Precio $">
        <select id="categoria">
            <option>Tecnolog√≠a</option><option>Ropa</option><option>Comida</option><option>Hogar</option><option>Otros</option>
        </select>
        <select id="depto"><option value="">Seleccionar Departamento</option></select>
        <input type="file" id="fotosInput" multiple accept="image/*">
        <button onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil de Vendedor</h3>
        <img id="imgPerfilPrevia" class="foto-perfil-v" src="https://via.placeholder.com/80">
        <input type="file" id="fotoPerfilFile" accept="image/*">
        <input id="perfilNombre" placeholder="Tu nombre real o negocio">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77889900)">
        <button id="btnGuardarP" onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold">Guardar Cambios</button>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none">Cerrar</button>
    </div>
</div>

<div id="visorFotoInterno" onclick="this.style.display='none'">
    <img id="fotoGrande" src="" style="max-width:90%; max-height:80%; margin:auto; display:block; border-radius:10px; margin-top:15%">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let productos = [];
let MI_ID = "";
let datosUsuario = { nombre: "", tel: "", foto: "" };

// --- L√ìGICA DE USUARIO Y PERFIL SINCRONIZADO ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        MI_ID = user.uid;
        document.getElementById('pantallaAuth').style.display = 'none';
        document.getElementById('statusHeader').innerText = `Hola, ${user.email}`;
        
        // Intentar cargar perfil desde Firebase
        const docRef = doc(db, "perfiles", MI_ID);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            datosUsuario = docSnap.data();
            // Actualizar localmente para acceso r√°pido
            localStorage.setItem("p_nombre", datosUsuario.nombre);
            localStorage.setItem("p_tel", datosUsuario.tel);
            localStorage.setItem("p_foto", datosUsuario.foto);
        }
        
        verificarPerfil();
        cargar();
    } else {
        document.getElementById('pantallaAuth').style.display = 'flex';
    }
});

window.crearCuenta = async () => {
    const e = document.getElementById('correoAuth').value, p = document.getElementById('claveAuth').value;
    try { await createUserWithEmailAndPassword(auth, e, p); } catch (err) { alert("Error: " + err.message); }
};

window.entrar = async () => {
    const e = document.getElementById('correoAuth').value, p = document.getElementById('claveAuth').value;
    try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { alert("Credenciales incorrectas"); }
};

window.salir = () => signOut(auth).then(() => location.reload());

window.guardarPerfil = async () => {
    const btn = document.getElementById('btnGuardarP');
    btn.innerText = "Guardando...";
    btn.disabled = true;

    const nuevoPerfil = {
        nombre: document.getElementById('perfilNombre').value,
        tel: document.getElementById('perfilTelefono').value,
        foto: datosUsuario.foto || ""
    };

    try {
        await setDoc(doc(db, "perfiles", MI_ID), nuevoPerfil);
        datosUsuario = nuevoPerfil;
        localStorage.setItem("p_nombre", nuevoPerfil.nombre);
        localStorage.setItem("p_tel", nuevoPerfil.tel);
        localStorage.setItem("p_foto", nuevoPerfil.foto);
        verificarPerfil();
        cerrarPerfil();
        alert("¬°Perfil sincronizado!");
    } catch (e) { alert("Error al guardar"); }
    
    btn.innerText = "Guardar Cambios";
    btn.disabled = false;
};

// --- FOTOS ---
const toBase64 = f => new Promise((res, rej) => {
    const r = new FileReader(); r.readAsDataURL(f);
    r.onload = () => res(r.result); r.onerror = e => rej(e);
});

document.getElementById('fotoPerfilFile').onchange = async (e) => {
    const file = e.target.files[0];
    if(file) {
        const b64 = await toBase64(file);
        datosUsuario.foto = b64;
        document.getElementById('imgPerfilPrevia').src = b64;
    }
};

// --- MARKET LOGIC ---
function verificarPerfil() {
    const n = localStorage.getItem("p_nombre"), t = localStorage.getItem("p_tel");
    const listo = (n && t);
    document.getElementById("bannerPerfil").style.display = listo ? "none" : "block";
    return listo;
}

window.publicar = async () => {
    const t = document.getElementById('titulo').value, p = document.getElementById('precio').value;
    const fFiles = document.getElementById('fotosInput').files;
    
    if(!t || !p || fFiles.length === 0) return alert("Completa los datos y sube al menos 1 foto");

    const fotos = [];
    for(let f of fFiles) fotos.push(await toBase64(f));

    await addDoc(collection(db,"productos"), {
        titulo: t, descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2), fotos: fotos,
        categoria: document.getElementById('categoria').value,
        depto: document.getElementById('depto').value,
        vendedor: localStorage.getItem("p_nombre"), 
        telefono: localStorage.getItem("p_tel"),
        fotoV: localStorage.getItem("p_foto"),
        creado: Date.now(), duenoId: MI_ID, vendido: false, oculto: false
    });
    location.reload();
};

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    lista.forEach(p => {
        const esMio = p.duenoId === MI_ID;
        feed.innerHTML += `
            <div class="card" style="${p.vendido ? 'opacity:0.6' : ''}">
                ${p.vendido ? '<div class="sold-overlay">VENDIDO</div>' : ''}
                <img class="foto-principal" src="${p.fotos[0]}" onclick="verImg('${p.fotos[0]}')">
                <div class="info">
                    <div style="font-weight:700; font-size:15px">$${p.precio}</div>
                    <div style="font-size:13px; line-height:1.2; height:32px; overflow:hidden">${p.titulo}</div>
                    <div style="font-size:10px; color:var(--mut)"><i class="fa-solid fa-location-dot"></i> ${p.depto}</div>
                    ${!p.vendido ? `<a class="btn-wa" href="https://wa.me/503${p.telefono}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>` : ''}
                    ${esMio && !p.vendido ? `<button onclick="marcarVendido('${p.id}')" style="margin-top:5px; cursor:pointer">Marcar Vendido</button>` : ''}
                </div>
            </div>`;
    });
}

// --- INTERFAZ ---
window.abrir = () => !verificarPerfil() ? abrirPerfil() : document.getElementById('modal').style.display="block";
window.cerrar = () => document.getElementById('modal').style.display="none";
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display="none";
window.abrirPerfil = () => {
    document.getElementById('perfilNombre').value = localStorage.getItem("p_nombre") || "";
    document.getElementById('perfilTelefono').value = localStorage.getItem("p_tel") || "";
    document.getElementById('imgPerfilPrevia').src = localStorage.getItem("p_foto") || "https://via.placeholder.com/80";
    document.getElementById('modalPerfil').style.display = "block";
};

window.marcarVendido = async (id) => {
    if(confirm("¬øConfirmas que ya vendiste este producto?")) {
        await updateDoc(doc(db,"productos",id), {vendido:true});
        cargar();
    }
};

window.verImg = (s) => { document.getElementById('fotoGrande').src=s; document.getElementById('visorFotoInterno').style.display='block'; };
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
window.setCat = (c, b) => {
    document.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    render(c === "Todos" ? productos : productos.filter(p => p.categoria === c));
};
window.filtrar = () => {
    const t = document.getElementById('buscar').value.toLowerCase();
    render(productos.filter(p => p.titulo.toLowerCase().includes(t)));
};

// Datos El Salvador
const deptos = ["Ahuachap√°n", "Santa Ana", "Sonsonate", "Chalatenango", "La Libertad", "San Salvador", "Cuscatl√°n", "La Paz", "Caba√±as", "San Vicente", "Usulut√°n", "San Miguel", "Moraz√°n", "La Uni√≥n"];
const ds = document.getElementById('depto');
deptos.forEach(d => ds.innerHTML += `<option value="${d}">${d}</option>`);

</script>
</body>
</html>
