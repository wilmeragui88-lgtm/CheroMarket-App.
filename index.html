<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain: "cheromarket.firebaseapp.com",
    projectId: "cheromarket",
    storageBucket: "cheromarket.firebasestorage.app",
    messagingSenderId: "777368646513",
    appId: "1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Datos de El Salvador
const svData = {"AhuachapÃ¡n": ["AhuachapÃ¡n", "Jujutla", "Atiquizaya", "ConcepciÃ³n de Ataco", "El Refugio", "Guaymango", "Apaneca", "San Francisco MenÃ©ndez", "San Lorenzo", "San Pedro Puxtla", "TurÃ­n"],"Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "MetapÃ¡n", "San Antonio Pajonal", "San SebastiÃ¡n Salitrillo", "Santa Rosa GuachipilÃ­n", "Santiago de la Frontera", "Texistepeque"],"Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "JuayÃºa", "Nahuizalco", "Nahulingo", "SalcoatitÃ¡n", "San Antonio del Monte", "San JuliÃ¡n", "Santa Catarina Masahuat", "Santa Isabel IshuatÃ¡n", "Santo Domingo de GuzmÃ¡n", "Sonzacate"],"Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "CitalÃ¡", "Comalapa", "ConcepciÃ³n Quezaltepeque", "Dulce Nombre de MarÃ­a", "El Carrizal", "El ParaÃ­so", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de JesÃºs", "Nueva ConcepciÃ³n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco MorazÃ¡n", "San Ignacio", "San Isidro Labrador", "San JosÃ© Cancasque", "San JosÃ© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],"La Libertad": ["Santa Tecla", "Antiguo CuscatlÃ¡n", "ChiltiupÃ¡n", "Ciudad Arce", "ColÃ³n", "Comasagua", "HuizÃºcar", "Jayaque", "Jicalapa", "La Libertad", "Nuevo CuscatlÃ¡n", "Quezaltepeque", "San Juan Opico", "Sacacoyo", "San JosÃ© Villanueva", "San MatÃ­as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],"San Salvador": ["San Salvador", "Ayutuxtepeque", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San MartÃ­n", "Santiago Texacuangos", "Santo TomÃ¡s", "Soyapango", "Tonacatepeque", "Delgado", "Cuscatancingo", "Ilopango", "Guazapa", "Aguilares", "El Paisnal"],"CuscatlÃ¡n": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de ConcepciÃ³n", "San BartolomÃ© PerulapÃ­a", "San CristÃ³bal", "San JosÃ© Guayabal", "San Rafael Cedros", "San RamÃ³n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo", "San Pedro PerulapÃ¡n"],"La Paz": ["Zacatecoluca", "CuyultitÃ¡n", "El Rosario", "JerusalÃ©n", "Mercedes La Ceiba", "Olocuilta", "ParaÃ­so de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Marcelino", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa MarÃ­a Ostuma", "Santiago Nonualco", "TapalhuacÃ¡n"],"CabaÃ±as": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Victoria"],"San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San SebastiÃ¡n", "Santa Clara", "Santo Domingo", "Tecoluca", "TepetitÃ¡n", "Verapaz"],"UsulutÃ¡n": ["UsulutÃ¡n", "AlegrÃ­a", "BerlÃ­n", "California", "ConcepciÃ³n Batres", "El Triunfo", "EreguayquÃ­n", "Estanzuelas", "Jiquilisco", "Jucuapa", "JucuarÃ¡n", "Mercedes UmaÃ±a", "Nueva Granada", "OzatlÃ¡n", "Puerto El Triunfo", "San AgustÃ­n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa MarÃ­a", "Santiago de MarÃ­a", "TecapÃ¡n"],"San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "ComacarÃ¡n", "Gualococti", "Guatajiagua", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo EdÃ©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],"MorazÃ¡n": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de ConcepciÃ³n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Loloquique", "Meanguera", "Osicala", "PerquÃ­n", "San Carlos", "San Fernando", "San Isidro", "San SimÃ³n", "Sensembra", "Sociedad", "Torola", "Yamabal", "YoloaiquÃ­n"],"La UniÃ³n": ["La UniÃ³n", "Conchagua", "El Carmen", "IntipucÃ¡", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "PolorÃ³s", "San Alejo", "San JosÃ©", "Santa Rosa de Lima", "Yayantique", "YucuaiquÃ­n", "Lislique", "AnamorÃ³s", "ConcepciÃ³n de Oriente", "El Sauce"]};

setPersistence(auth, browserLocalPersistence);

let productos = [];
let favoritos = JSON.parse(localStorage.getItem("mis_favoritos")) || [];
const state = { categoria: "Todos" };
let MI_ID = null;
let fotosAnuncio = ["", "", ""];
let fotoPerfilBase64 = localStorage.getItem("p_foto") || "";

// MONITOR DE SESIÃ“N
onAuthStateChanged(auth, async (user) => {
    if (user) {
        MI_ID = user.uid;
        document.getElementById('modalLogin').style.display = 'none';
        
        // Recuperar datos del perfil desde Firestore
        const docRef = doc(db, "usuarios", user.uid);
        const dSnap = await getDoc(docRef);
        
        if (dSnap.exists()) {
            const data = dSnap.data();
            localStorage.setItem("p_nombre", data.nombre || "");
            localStorage.setItem("p_tel", data.telefono || "");
            if(data.foto) {
                fotoPerfilBase64 = data.foto;
                localStorage.setItem("p_foto", data.foto);
            }
        }
        verificarPerfil();
        cargar();
    } else {
        document.getElementById('modalLogin').style.display = 'flex';
    }
});

// FUNCIONES DE ACCESO
window.entrarApp = async () => {
    const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
    if(!e || !p) return alert("Hey chero, pon tu correo y clave.");
    try { await signInWithEmailAndPassword(auth, e, p); } 
    catch (err) { alert("âŒ Datos incorrectos o usuario no existe."); }
};

window.registrarApp = async () => {
    const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
    if(!e || p.length < 6) return alert("Escribe un correo vÃ¡lido y clave de min. 6 caracteres");
    try { 
        await createUserWithEmailAndPassword(auth, e, p); 
        alert("âœ… Â¡Cuenta creada con Ã©xito! Ahora configura tu perfil.");
    } catch (err) { alert("Error: " + err.message); }
};

window.cerrarSesion = async () => {
    if(confirm("Â¿Cerrar sesiÃ³n?")) {
        await signOut(auth);
        localStorage.clear();
        location.reload();
    }
};

// GESTIÃ“N DE PERFIL (CORREGIDA)
window.guardarPerfil = async () => {
    if (!MI_ID) return alert("Debes iniciar sesiÃ³n primero.");

    const n = document.getElementById('perfilNombre').value.trim();
    const t = document.getElementById('perfilTelefono').value.trim();

    if (!n || !t) return alert("Por favor, pon tu nombre y WhatsApp.");

    try {
        await setDoc(doc(db, "usuarios", MI_ID), {
            nombre: n,
            telefono: t,
            foto: fotoPerfilBase64,
            actualizado: Date.now()
        }, { merge: true });

        localStorage.setItem("p_nombre", n);
        localStorage.setItem("p_tel", t);
        localStorage.setItem("p_foto", fotoPerfilBase64);

        verificarPerfil();
        document.getElementById('modalPerfil').style.display = "none";
        alert("Â¡Perfil guardado, chero! âœ…");
    } catch (err) {
        console.error(err);
        alert("Error al guardar: " + err.message);
    }
};

window.verificarPerfil = () => {
    const n = localStorage.getItem("p_nombre"), t = localStorage.getItem("p_tel");
    const incompleto = (!n || n === "" || !t || t === "");
    document.getElementById("bannerPerfil").style.display = incompleto ? "block" : "none";
    return !incompleto;
};

// PUBLICAR
window.publicar = async () => {
    const t = document.getElementById('titulo').value, p = document.getElementById('precio').value;
    const cant = document.getElementById('cantidad').value;
    const fotosFinales = fotosAnuncio.filter(f => f !== "");
    
    if(!t || !p || fotosFinales.length === 0) return alert("Faltan datos o fotos.");
    if(!verificarPerfil()) return alert("Configura tu perfil antes de vender.");

    await addDoc(collection(db,"productos"), {
        titulo: t, 
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2), 
        cantidad: parseInt(cant) || 1,
        fotos: fotosFinales,
        categoria: document.getElementById('categoria').value,
        entrega: document.getElementById('opcionEnvio').value,
        depto: document.getElementById('depto').value, 
        muni: document.getElementById('muni').value,
        vendedor: localStorage.getItem("p_nombre"), 
        telefono: localStorage.getItem("p_tel"),
        fotoPerfilVendedor: fotoPerfilBase64,
        creado: Date.now(), 
        duenoId: MI_ID, 
        vendido: false, 
        oculto: false
    });
    alert("Â¡Publicado con Ã©xito! ðŸš€");
    location.reload();
};

// ... RESTO DE TUS FUNCIONES (cargar, render, filtrar, etc.) ...
async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    const disp = lista.filter(p => !p.vendido);
    const vend = lista.filter(p => p.vendido);
    disp.forEach(p => feed.innerHTML += crearCard(p));
    if(vend.length > 0) {
        feed.innerHTML += `<div class="seccion-titulo">AGOTADOS / VENDIDOS (${vend.length})</div>`;
        vend.forEach(p => feed.innerHTML += crearCard(p));
    }
}

function crearCard(p) {
    const esFav = favoritos.includes(p.id);
    const esMio = p.duenoId === MI_ID;
    const esEnvio = p.entrega === "EnvÃ­os a todo el paÃ­s";
    const fotos = Array.isArray(p.fotos) ? p.fotos : (p.foto ? [p.foto] : []);
    
    let miniHTML = "";
    if(fotos.length > 1) {
        miniHTML = `<div class="miniaturas-cont">
            ${fotos.map(f => `<img src="${f}" class="mini-foto" onclick="this.closest('.card').querySelector('.foto-principal').src='${f}'">`).join('')}
        </div>`;
    }

    return `
        <div class="card" style="${p.vendido ? 'opacity:0.6' : ''}">
            <button class="btn-fav ${esFav?'active':''}" onclick="event.stopPropagation(); toggleFavorito('${p.id}')"><i class="fa-solid fa-heart"></i></button>
            <button class="btn-share-post" onclick="event.stopPropagation(); compartirPost('${p.titulo}', '${p.precio}', '${p.muni}')"><i class="fa-solid fa-share-nodes"></i></button>
            ${p.vendido ? '<div class="sold-overlay">AGOTADO</div>' : ''}
            <img class="foto-principal" src="${fotos[0] || 'https://via.placeholder.com/160'}" onclick="verImagenFull(this.src)">
            ${miniHTML}
            <div class="info">
                <div class="tags-cont">
                    <span class="tag">${p.categoria}</span>
                    <span class="tag-envio" style="background:${esEnvio?'var(--azul)':'var(--mut)'}">${p.entrega}</span>
                </div>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="loc">${p.muni}, ${p.depto}</div>
                <div class="vendedor-link" onclick="verCatalogo('${p.duenoId}', '${p.vendedor}', '${p.fotoPerfilVendedor}')">
                    <i class="fa-solid fa-store"></i> Ver tienda de ${p.vendedor}
                </div>
                ${!p.vendido ? `<a class="btn-wa" href="https://wa.me/503${p.telefono}"><i class="fa-brands fa-whatsapp"></i> Preguntar</a>` : ''}
                ${esMio && !p.vendido ? `<button class="btn-vendido-accion" onclick="marcarVendido('${p.id}')">Marcar Agotado</button>` : ''}
                ${esMio ? `<button class="btn-eliminar-accion" onclick="eliminar('${p.id}')">Eliminar</button>` : ''}
            </div>
        </div>`;
}

// UI Helpers
window.abrirPerfil = () => {
    document.getElementById('perfilNombre').value = localStorage.getItem("p_nombre") || "";
    document.getElementById('perfilTelefono').value = localStorage.getItem("p_tel") || "";
    document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64 || "https://via.placeholder.com/80";
    document.getElementById('modalPerfil').style.display = "block";
};
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";
window.abrir = () => !verificarPerfil() ? (alert("Completa tu perfil primero"), abrirPerfil()) : document.getElementById('modal').style.display = "block";
window.cerrar = () => document.getElementById('modal').style.display = "none";
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";

// Manejo de fotos de perfil
document.getElementById('fotoPerfilFile').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 200;
            canvas.getContext('2d').drawImage(img, 0, 0, 200, 200);
            fotoPerfilBase64 = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64;
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

// Init select de departamentos
const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});
window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value, m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};
</script>
