
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CheroMarketApp ¬∑ Pro</title>

<style>
:root{
--azul:#0047AB;--naranja:#FF8C00;--verde:#25D366;
--fondo:#f0f2f5;--card:#fff;--txt:#333;--mut:#777;--b:#ddd;--rojo:#c62828
}
[data-theme=dark]{
--fondo:#121212;--card:#1e1e1e;--txt:#eee;--mut:#aaa;--b:#333;--azul:#4c8cff
}
body{margin:0;font-family:Segoe UI;background:var(--fondo);color:var(--txt);padding-bottom:80px}
header{background:var(--card);border-bottom:3px solid var(--azul);padding:15px;text-align:center;position:sticky;top:0;z-index:9}
h1{margin:0;color:var(--azul)}
.sub{font-size:13px;color:var(--mut)}

/* Bot√≥n Men√∫ Hamburguesa */
.btn-menu{position:absolute;right:15px;top:20px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--azul)}

/* Sidebar / Men√∫ Lateral */
.sidebar{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--card);box-shadow:-2px 0 10px rgba(0,0,0,0.2);z-index:100;transition:0.3s;padding:20px;box-sizing:border-box;overflow-y:auto}
.sidebar.active{right:0}
.sidebar h2{color:var(--azul);font-size:18px;margin-top:0}
.sidebar-item{margin-bottom:20px;font-size:14px;line-height:1.4;border-bottom:1px solid var(--b);padding-bottom:10px}
.close-sidebar{background:var(--b);border:none;padding:8px;width:100%;border-radius:8px;cursor:pointer;margin-bottom:20px}

.buscador-cont{max-width:500px;margin:10px auto;display:flex;gap:8px}
.buscador{flex:1;padding:12px;border-radius:25px;border:1px solid var(--b);background:var(--fondo)}
.btn-theme{width:40px;height:40px;border:none;border-radius:50%;cursor:pointer}
.categorias{display:flex;gap:8px;overflow-x:auto;padding:10px;max-width:500px;margin:auto}
.cat{padding:8px 14px;border:none;border-radius:20px;font-weight:600;background:var(--b);cursor:pointer;white-space:nowrap}
.cat.active{background:var(--azul);color:white}
.feed{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;max-width:900px;margin:auto}
.card{background:var(--card);border-radius:12px;border:1px solid var(--b);overflow:hidden;display:flex;flex-direction:column;transition: 0.3s;position:relative}
.foto{height:180px;width:100%;object-fit:cover;background:#eee}
.info{padding:12px;display:flex;flex-direction:column;gap:5px;flex:1}
.tag-row{display:flex;gap:5px;flex-wrap:wrap}
.tag{font-size:10px;border:1px solid var(--azul);color:var(--azul);padding:2px 8px;border-radius:6px}
.tag-estado{background:var(--azul);color:white}
.tag-vendido{background:var(--rojo);color:white;border-color:var(--rojo)}
.titulo{font-weight:600;font-size:16px;margin-top:5px}
.precio{color:var(--naranja);font-size:20px;font-weight:700}
.desc{font-size:12px;color:var(--txt);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.mut{font-size:11px;color:var(--mut)}
.btn-wa{margin-top:auto;background:var(--verde);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-weight:600}
.btn-del{background:transparent;color:var(--rojo);border:none;padding:5px;font-size:11px;cursor:pointer;text-decoration:underline;margin-top:5px}
.btn-sold{background:var(--txt);color:var(--card);border:none;padding:8px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:bold}
.btn-add{position:fixed;bottom:20px;right:20px;width:65px;height:65px;border-radius:50%;background:var(--naranja);color:white;font-size:32px;border:none;box-shadow: 0 4px 10px rgba(0,0,0,0.3);z-index:10}
#modal, #modalPerfil{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:99;overflow-y:auto;padding:20px}
.modal-content{background:var(--card);max-width:500px;margin:auto;padding:20px;border-radius:15px;display:flex;flex-direction:column;gap:12px}
input,select,textarea{padding:12px;border-radius:8px;border:1px solid var(--b);background:var(--fondo);color:var(--txt);font-family:inherit}
textarea{resize:none;height:80px}
.sold-overlay{position:absolute;top:10px;right:10px;background:var(--rojo);color:white;padding:4px 10px;border-radius:4px;font-weight:bold;font-size:12px;z-index:1}
</style>
</head>

<body data-theme="light">
<div id="capa-legal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
      
      <div style="font-family: 'Segoe UI', Roboto, Arial, sans-serif; max-width: 500px; width: 90%; margin: 20px; border-radius: 15px; overflow: hidden; background: #ffffff; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        
        <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee; text-align: center;">
          <h2 style="margin: 0; color: #333; font-size: 1.4em;">üõ°Ô∏è Seguridad CheroMarket</h2>
          <p style="font-size: 0.9em; color: #666;">Para continuar, debes aceptar nuestras pol√≠ticas.</p>
        </div>
    
        <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
            </div>
    
        <div style="padding: 20px; background: white;">
          <button id="btn-aceptar-terminos" style="width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;">
            Acepto y deseo continuar
          </button>
        </div>
      </div>
    </div>
    

<header>
    <button class="btn-menu" onclick="toggleMenu()">‚ò∞</button>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div class="sub">Vende y compra en todo El Salvador</div>

    <div class="buscador-cont">
        <input id="buscar" class="buscador" placeholder="Buscar por nombre o lugar‚Ä¶" oninput="filtrar()">
        <button class="btn-theme" onclick="toggleTheme()">üåì</button>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)">Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)">Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)">Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)">Comida</button>
        <button class="cat" style="background:var(--naranja);color:white" onclick="abrirPerfil()">üë§ Mi Perfil</button>
    </div>
</header>

<div id="sidebar" class="sidebar">
    <button class="close-sidebar" onclick="toggleMenu()">‚úï Cerrar Men√∫</button>
    
<div style="font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 20px auto; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #ffffff;">
   
     <details style="border-bottom: 1px solid #eee;">
       <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #f8f9fa; color: #333; display: flex; align-items: center; list-style: none;">
         <span style="margin-right: 12px; font-size: 1.2em;">üìú</span> T√©rminos y Condiciones de CheroMarketApp
       </summary>
       <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; border-top: 1px solid #eee;">
         <h4 style="margin-top: 0;">1. Aceptaci√≥n de los T√©rminos</h4>
         <p>Al descargar, instalar o usar CheroMarketApp, el usuario acepta cumplir con estos t√©rminos. Si no est√° de acuerdo, debe abstenerse de utilizar la plataforma.</p>
         <h4>2. Descripci√≥n del Servicio</h4>
         <p>CheroMarketApp es una plataforma intermediaria que permite a los usuarios publicar anuncios de productos o servicios para su compra y venta en el territorio de El Salvador. La aplicaci√≥n no es due√±a, no vende, ni garantiza los art√≠culos publicados por terceros.</p>
         <h4>3. Registro y Seguridad</h4>
         <ul>
           <li>Solo podr√°n registrarse personas mayores de 18 a√±os.</li>
           <li>El usuario es responsable de mantener la confidencialidad de sus credenciales de acceso.</li>
           <li>Cualquier actividad realizada bajo la cuenta del usuario ser√° su responsabilidad exclusiva.</li>
         </ul>
         <h4>4. Reglas de Publicaci√≥n y Uso</h4>
         <p>Queda estrictamente prohibido publicar art√≠culos ilegales seg√∫n las leyes de la Rep√∫blica de El Salvador, contenido ofensivo o productos falsificados.</p>
         <h4>5. Responsabilidad en las Transacciones</h4>
         <p>CheroMarketApp no participa en la negociaci√≥n ni entrega. El contacto y la transacci√≥n financiera ocurren exclusivamente entre comprador y vendedor.</p>
         <h4>6. Privacidad de Datos</h4>
         <p>El uso de datos personales se rige por nuestra Pol√≠tica de Privacidad, cumpliendo con los est√°ndares de protecci√≥n de datos en el pa√≠s.</p>
         <h4>7. Suspensi√≥n y Terminaci√≥n</h4>
         <p>Nos reservamos el derecho de suspender cuentas que infrinjan estos t√©rminos sin previo aviso.</p>
         <h4>8. Modificaciones</h4>
         <p>Podemos actualizar estos t√©rminos en cualquier momento notificando cambios significativos.</p>
         <h4>9. Jurisdicci√≥n y Ley Aplicable</h4>
         <p>Leyes de la Rep√∫blica de El Salvador. Disputas ante tribunales de San Salvador.</p>
       </div>
     </details>
   
     <details style="border-bottom: 1px solid #eee;">
       <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #f8f9fa; color: #333; display: flex; align-items: center; list-style: none;">
         <span style="margin-right: 12px; font-size: 1.2em;">‚öñÔ∏è</span> Pol√≠tica de Privacidad
       </summary>
       <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; border-top: 1px solid #eee;">
         <p><em>√öltima actualizaci√≥n: 22 de enero de 2026</em></p>
         <h4>1. Informaci√≥n que Recopilamos</h4>
         <p>Recolectamos informaci√≥n de registro (nombre, email, tel√©fono), contenido del usuario (fotos, mensajes), datos de ubicaci√≥n y del dispositivo.</p>
         <h4>2. Uso de la Informaci√≥n</h4>
         <p>Para facilitar anuncios, personalizar tu experiencia en El Salvador, enviar notificaciones y mantener la seguridad.</p>
         <h4>3. C√≥mo Compartimos tu Informaci√≥n</h4>
         <p>Tu nombre y tel√©fono pueden ser visibles en anuncios. No vendemos tus datos a terceros con fines publicitarios.</p>
         <h4>4. Tus Derechos</h4>
         <p>Puedes editar tu perfil, solicitar la eliminaci√≥n de tu cuenta o gestionar permisos de ubicaci√≥n y c√°mara desde tu dispositivo.</p>
       </div>
     </details>
   
     <details style="border-bottom: 1px solid #eee;">
       <summary style="padding: 18px; cursor: pointer; font-weight: bold; background-color: #e8f4fd; color: #0056b3; display: flex; align-items: center; list-style: none;">
         <span style="margin-right: 12px; font-size: 1.2em;">üõ°Ô∏è</span> Gu√≠a de Seguridad para Cheros
       </summary>
       <div style="padding: 20px; color: #444; font-size: 14px; line-height: 1.6; background-color: #fafcfe;">
         <p><strong>ü§ù Negocios Seguros:</strong> Re√∫nete en centros comerciales o gasolineras con c√°maras. Ve acompa√±ado y de d√≠a.</p>
         <p><strong>üí∞ Pagos:</strong> <strong>NUNCA</strong> env√≠es dinero por adelantado. Verifica el saldo disponible en tu banco antes de entregar el producto.</p>
         <p><strong>üì¶ Verificaci√≥n:</strong> Prueba los electr√≥nicos y revisa documentos de veh√≠culos en el VMT antes de pagar.</p>
       </div>
     </details>
   
     <div style="padding: 20px; text-align: center; background-color: #ffffff;">
       <button type="button" style="width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); transition: background 0.3s;" onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'">
         Acepto todos los T√©rminos y Condiciones
       </button>
       <p style="font-size: 11px; color: #999; margin-top: 10px;">Al hacer clic, confirmas que has le√≠do y comprendido los documentos legales de CheroMarketApp.</p>
     </div>
   
   </div>
    
    <div class="sidebar-item">
        <p class="mut">Versi√≥n 1.2 Pro ¬∑ 2026</p>
    </div>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()">+</button>

<div id="modalPerfil">
    <div class="modal-content">
        <h3 style="margin:0">Configurar mi Perfil</h3>
        <p class="mut">Estos datos aparecer√°n en tus anuncios para que te contacten.</p>
        <input id="perfilNombre" placeholder="Tu nombre o negocio">
        <input id="perfilTelefono" type="number" placeholder="Tu WhatsApp (ej: 77771234)">
        <button type="button" onclick="guardarPerfil()" style="background:var(--verde);color:white;padding:15px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Guardar Cambios</button>
        <button type="button" onclick="cerrarPerfil()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cerrar</button>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 style="margin:0">Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes?">
        <textarea id="descripcion" placeholder="Describe tu producto (detalles, fallas, etc.)"></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" step="0.01" placeholder="Precio $" style="flex:1">
            <select id="estado" style="flex:1">
                <option value="Nuevo">Nuevo</option>
                <option value="Usado">Usado</option>
            </select>
        </div>
        <input id="fotoUrl" placeholder="URL de la imagen (ej: https://...)">
        <select id="categoria">
            <option>Tecnolog√≠a</option>
            <option>Ropa</option>
            <option>Comida</option>
            <option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()">
            <option value="">Selecciona Departamento</option>
        </select>
        <select id="muni">
            <option value="">Selecciona Municipio</option>
        </select>
        <button 
async function alIntentarPublicar() {
            const user = auth.currentUser;
            
            if (!user) {
                alert("Debes estar registrado");
                return;
            }
        
            const docSnap = await getDoc(doc(db, "usuarios_seguros", user.uid));
            
            if (!docSnap.exists()) {
                capaLegal.style.display = 'flex'; // Le mostramos los t√©rminos si no los tiene
                alert("Debes aceptar los t√©rminos de seguridad antes de vender.");
            } else {
                // AQU√ç ABRES TU FORMULARIO DE PUBLICACI√ìN
                abrirFormularioPublicar();
            }
        }
        
        type="button" onclick="publicar()" style="background:var(--azul);color:white;padding:15px;border:none;border-radius:8px;font-weight
            :bold;cursor:pointer">Publicar Ahora
          </button>
        <button type="button" onclick="cerrar()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cancelar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
authDomain:"cheromarket.firebaseapp.com",
projectId:"cheromarket",
storageBucket:"cheromarket.firebasestorage.app",
messagingSenderId:"777368646513",
appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// L√ìGICA DE MEN√ö HAMBURGUESA
window.toggleMenu = () => {
    document.getElementById('sidebar').classList.toggle('active');
};

// --- L√ìGICA DE IDENTIDAD Y PERFIL ---
if(!localStorage.getItem("mi_id_usuario")) {
    localStorage.setItem("mi_id_usuario", "user_" + Math.random().toString(36).substr(2, 9));
}
const MI_ID = localStorage.getItem("mi_id_usuario");

const obtenerPerfil = () => ({
    nombre: localStorage.getItem("perfil_nombre") || "Vendedor An√≥nimo",
    telefono: localStorage.getItem("perfil_telefono") || "77771234"
});

window.abrirPerfil = () => {
    const p = obtenerPerfil();
    document.getElementById('perfilNombre').value = p.nombre === "Vendedor An√≥nimo" ? "" : p.nombre;
    document.getElementById('perfilTelefono').value = p.telefono === "77771234" ? "" : p.telefono;
    document.getElementById('modalPerfil').style.display = "block";
};

window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

window.guardarPerfil = () => {
    const nom = document.getElementById('perfilNombre').value.trim();
    const tel = document.getElementById('perfilTelefono').value.trim();
    if(!nom || !tel) return alert("Por favor completa tu nombre y tel√©fono");
    localStorage.setItem("perfil_nombre", nom);
    localStorage.setItem("perfil_telefono", tel);
    alert("Perfil actualizado correctamente");
    cerrarPerfil();
};

const svData = {
"Ahuachap√°n": ["Ahuachap√°n", "Jujutla", "Atiquizaya", "Concepci√≥n de Ataco", "El Refugio", "Guaymango", "Apaneca", "San Francisco Men√©ndez", "San Lorenzo", "San Pedro Puxtla", "Tur√≠n"],
"Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Metap√°n", "San Antonio Pajonal", "San Sebasti√°n Salitrillo", "Santa Rosa Guachipil√≠n", "Santiago de la Frontera", "Texistepeque"],
"Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juay√∫a", "Nahuizalco", "Nahulingo", "Salcoatit√°n", "San Antonio del Monte", "San Juli√°n", "Santa Catarina Masahuat", "Santa Isabel Ishuat√°n", "Santo Domingo de Guzm√°n", "Sonzacate"],
"Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "Cital√°", "Comalapa", "Concepci√≥n Quezaltepeque", "Dulce Nombre de Mar√≠a", "El Carrizal", "El Para√≠so", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de Jes√∫s", "Nueva Concepci√≥n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Moraz√°n", "San Ignacio", "San Isidro Labrador", "San Jos√© Cancasque", "San Jos√© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
"La Libertad": ["Santa Tecla", "Antiguo Cuscatl√°n", "Chiltiup√°n", "Ciudad Arce", "Col√≥n", "Comasagua", "Huiz√∫car", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatl√°n", "Quezaltepeque", "San Juan Opico", "Sacacoyo", "San Jos√© Villanueva", "San Mat√≠as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
"San Salvador": ["San Salvador", "Ayutuxtepeque", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Mart√≠n", "Santiago Texacuangos", "Santo Tom√°s", "Soyapango", "Tonacatepeque", "Delgado", "Cuscatancingo", "Ilopango", "Guazapa", "Aguilares", "El Paisnal"],
"Cuscatl√°n": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepci√≥n", "San Bartolom√© Perulap√≠a", "San Crist√≥bal", "San Jos√© Guayabal", "San Rafael Cedros", "San Ram√≥n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo", "San Pedro Perulap√°n"],
"La Paz": ["Zacatecoluca", "Cuyultit√°n", "El Rosario", "Jerusal√©n", "Mercedes La Ceiba", "Olocuilta", "Para√≠so de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Marcelino", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa Mar√≠a Ostuma", "Santiago Nonualco", "Tapalhuac√°n"],
"Caba√±as": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Victoria"],
"San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebasti√°n", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetit√°n", "Verapaz"],
"Usulut√°n": ["Usulut√°n", "Alegr√≠a", "Berl√≠n", "California", "Concepci√≥n Batres", "El Triunfo", "Ereguayqu√≠n", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuar√°n", "Mercedes Uma√±a", "Nueva Granada", "Ozatl√°n", "Puerto El Triunfo", "San Agust√≠n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa Mar√≠a", "Santiago de Mar√≠a", "Tecap√°n"],
"San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacar√°n", "Gualococti", "Guatajiagua", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Ed√©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],
"Moraz√°n": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepci√≥n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Loloquique", "Meanguera", "Osicala", "Perqu√≠n", "San Carlos", "San Fernando", "San Isidro", "San Sim√≥n", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiqu√≠n"],
"La Uni√≥n": ["La Uni√≥n", "Conchagua", "El Carmen", "Intipuc√°", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polor√≥s", "San Alejo", "San Jos√©", "Santa Rosa de Lima", "Yayantique", "Yucuaiqu√≠n", "Lislique", "Anamor√≥s", "Concepci√≥n de Oriente", "El Sauce"]
};

const state = { categoria:"Todos" };

function initUbicaciones() {
    const deptoSelect = document.getElementById('depto');
    Object.keys(svData).forEach(d => {
        let opt = document.createElement('option');
        opt.value = d; opt.innerText = d;
        deptoSelect.appendChild(opt);
    });
}

window.actualizarMunicipios = () => {
    const deptoVal = document.getElementById('depto').value;
    const muniSelect = document.getElementById('muni');
    muniSelect.innerHTML = '<option value="">Selecciona Municipio</option>';
    if(deptoVal) {
        svData[deptoVal].forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            muniSelect.appendChild(opt);
        });
    }
};

window.toggleTheme=()=>document.body.dataset.theme=
document.body.dataset.theme==="dark"?"light":"dark";

window.abrir=()=>modal.style.display="block";
window.cerrar=()=>modal.style.display="none";

window.publicar = async () => {
    if(!titulo.value || !precio.value || !depto.value || !muni.value) return alert("Completa los campos obligatorios");
    
    const perfil = obtenerPerfil();
    const imagenFinal = fotoUrl.value || "https://via.placeholder.com/400?text=Sin+Foto";

    await addDoc(collection(db,"productos"),{
        titulo: titulo.value,
        descripcion: descripcion.value || "Sin descripci√≥n adicional",
        precio: Number(precio.value).toFixed(2),
        estado: estado.value,
        foto: imagenFinal,
        categoria: categoria.value,
        depto: depto.value,
        muni: muni.value,
        vendedor: perfil.nombre,
        telefono: perfil.telefono,
        creado: Date.now(),
        duenoId: MI_ID,
        vendido: false
    });
    
    titulo.value = ""; descripcion.value = ""; precio.value = ""; fotoUrl.value = "";
    cerrar();
    cargar();
};

window.eliminar = async id => {
    if(confirm("¬øEliminar este anuncio permanentemente?")){
        await deleteDoc(doc(db,"productos",id));
        cargar();
    }
};

window.marcarVendido = async id => {
    if(confirm("¬øMarcar este producto como vendido? Ya no se podr√° contactar.")){
        await updateDoc(doc(db,"productos",id), { vendido: true });
        cargar();
    }
};

window.setCat=(c,b)=>{
    state.categoria=c;
    document.querySelectorAll(".cat").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

window.filtrar=()=>{
    const t=buscar.value.toLowerCase();
    document.querySelectorAll(".card").forEach(c=>{
        c.style.display=
        (c.dataset.t.includes(t) || c.dataset.l.includes(t)) &&
        (state.categoria==="Todos"||c.dataset.c===state.categoria)
        ?"flex":"none";
    });
};

async function cargar(){
    const q=query(collection(db,"productos"),orderBy("creado","desc"));
    const snap=await getDocs(q);
    render(snap.docs.map(d=>({id:d.id,...d.data()})));
}

function render(lista){
    feed.innerHTML="";
    lista.forEach(p=>{
        const esDueno = p.duenoId === MI_ID;
        const estaVendido = p.vendido === true;

        let botonesPrivados = "";
        if(esDueno){
            botonesPrivados = `
                <div style="display:flex;gap:10px;margin-top:5px">
                    ${!estaVendido ? `<button class="btn-sold" onclick="marcarVendido('')">Marcar Vendido</button>` : ''}
                    <button class="btn-del" onclick="eliminar('')">Eliminar</button>
                </div>`;
        }

        const botonContacto = estaVendido 
            ? `<div style="text-align:center;color:var(--rojo);font-weight:bold;padding:10px;border:1px solid var(--rojo);border-radius:8px">NO DISPONIBLE</div>`
            : `<a class="btn-wa" target="_blank" href="https://wa.me/503?text=Hola! Me interesa el producto:  ($) que vi en CheroMarket.">Contactar</a>`;

        feed.innerHTML+=`
        <div class="card" data-t="" data-l="" data-c="">
             ''
            <img class="foto" src="" alt="producto" style="grayscale(1);opacity:0.6' : ''">
            <div class="info">
                <div class="tag-row">
                    <span class="tag"></span>
                    <span class="tag tag-estado  ''"> p.estado</span>
                </div>
                <div class="titulo"></div>
                <div class="precio">$</div>
                <div class="desc"></div>
                <div class="mut">üìç ,  <br>üë§ </div>
                
                
            </div>
        </div>`;
    });
}
// 1. Referencias de la UI
const capaLegal = document.getElementById('capa-legal');
const btnAceptar = document.getElementById('btn-aceptar-terminos');

// 2. Funci√≥n para verificar si ya acept√≥ al entrar a la app
function verificarEstatusLegal(user) {
    if (!user) return; // Si no hay usuario, no hacemos nada todav√≠a

    const docRef = doc(db, "usuarios_seguros", user.uid);
    getDoc(docRef).then((docSnap) => {
        if (!docSnap.exists()) {
            // SI NO EXISTE EL DOCUMENTO, BLOQUEAMOS LA PANTALLA
            capaLegal.style.display = 'flex';
        }
    });
}

// 3. Evento de Clic en el bot√≥n Aceptar
btnAceptar.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("Inicia sesi√≥n primero");
        return;
    }

    try {
        btnAceptar.disabled = true;
        btnAceptar.innerText = "Guardando seguridad...";

        // Guardamos en Firebase (Usando la info de su perfil de Google/Email)
        await setDoc(doc(db, "usuarios_seguros", user.uid), {
            nombre: user.displayName,
            email: user.email,
            uid: user.uid,
            fechaAceptacion: serverTimestamp(),
            terminosAceptados: true
        });

        // Cerramos el men√∫
        capaLegal.style.display = 'none';
        alert("¬°Todo listo! Ahora puedes publicar.");

    } catch (e) {
        console.error(e);
        alert("Error al guardar. Revisa tu conexi√≥n.");
        btnAceptar.disabled = false;
    }
});

// 4. Escuchar cuando el usuario inicia sesi√≥n para verificar su estatus
auth.onAuthStateChanged((user) => {
    if (user) {
        verificarEstatusLegal(user);
    }
});

initUbicaciones();
cargar();
</script>

</body>
</html>