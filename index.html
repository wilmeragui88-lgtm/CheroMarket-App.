<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp 췅 Pro 游젏릖</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0047AB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CheroMarket">

    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; position: sticky; top: 0; z-index: 10;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}

        .perfil-img-cont{text-align:center; position:relative; width:80px; margin:auto}
        .foto-perfil{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); background:#eee; cursor:pointer}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative;}
        .foto-principal{height:160px; width:100%; object-fit:cover; background:#eee; cursor: pointer;}
        
        .miniaturas-cont{display: flex; gap: 4px; padding: 6px; background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--b); overflow-x: auto;}
        .mini-foto{width: 35px; height: 35px; border-radius: 4px; object-fit: cover; border: 1px solid var(--b); cursor: pointer; flex-shrink: 0;}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tag-stock{font-size:10px; color:var(--verde); font-weight:bold; margin-top:2px}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .titulo{font-weight:600; font-size:14px; line-height: 1.2;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        
        /* MODALES */
        #modal, #modalPerfil, #visorFotoInterno{position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; z-index:99; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        
        /* VISOR MULTIPLE */
        #visorFotoInterno{ display:none; align-items:center; justify-content:center; padding:0; background:#000}
        .visor-container{ position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center }
        #fotoGrande{ max-width:100%; max-height:80vh; object-fit:contain }
        .nav-visor{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.2); color:white; border:none; padding:15px; cursor:pointer; border-radius:50%; font-size:20px }
        .btn-prev{ left:10px }
        .btn-next{ right:10px }
        .btn-cerrar-v{ position:absolute; top:20px; right:20px; color:white; font-size:30px; background:none; border:none }

        /* AUTH ESTILOS */
        .auth-box{ border: 1px solid var(--b); padding: 15px; border-radius: 10px; margin-top: 10px; background: var(--fondo) }
        .btn-auth{ padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; width: 100% }
        .link-pass{ text-align:center; font-size:12px; color:var(--azul); cursor:pointer; margin-top:10px; display:block; text-decoration: underline; }

        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--card); color:var(--txt); font-family:inherit}
        .subir-fotos-grid{display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;}
        .foto-input-box{border: 2px dashed var(--azul); border-radius: 8px; height: 70px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--fondo);}
        .foto-input-box input{opacity: 0; position: absolute; inset: 0; z-index: 2; cursor: pointer;}
        .foto-input-box img{width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; display:none}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    丘멆잺 <strong>춰Bienvenido!</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; text-decoration: underline;">Inicia sesi칩n o reg칤strate</a> para vender.
</div>

<header>
    <h1>游젏릖 CheroMarketApp</h1>
    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="쯈u칠 buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M치x" oninput="filtrar()">
    </div>
    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()"><option value="">游늸 Todo El Salvador</option></select>
    </div>
    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)">Todos</button>
        <button class="cat" onclick="setCat('Tecnolog칤a',this)">Tecnolog칤a</button>
        <button class="cat" onclick="setCat('Ropa',this)">Ropa</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()">Mi Perfil</button>
    </div>
</header>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="visorFotoInterno">
    <button class="btn-cerrar-v" onclick="cerrarVisor()"><i class="fa-solid fa-xmark"></i></button>
    <div class="visor-container">
        <button class="nav-visor btn-prev" onclick="cambiarFotoVisor(-1)"><i class="fa-solid fa-chevron-left"></i></button>
        <img id="fotoGrande" src="">
        <button class="nav-visor btn-next" onclick="cambiarFotoVisor(1)"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil de Vendedor</h3>
        
        <div id="areaPerfilLogueado" style="display:none">
            <div class="perfil-img-cont" onclick="document.getElementById('fotoPerfilFile').click()">
                <img id="imgPerfilPrevia" class="foto-perfil" src="https://via.placeholder.com/80">
                <input type="file" id="fotoPerfilFile" accept="image/*" style="display:none">
            </div>
            <input id="perfilNombre" placeholder="Nombre o Negocio">
            <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77771234)">
            <button onclick="guardarPerfil()" class="btn-auth" style="background:var(--verde); color:white">Actualizar Datos</button>
            <button onclick="verMisAnuncios()" class="btn-auth" style="background:var(--azul); color:white">Mis Anuncios</button>
            <hr>
            <p id="txtSesion" style="font-size:12px; text-align:center; color:var(--mut)"></p>
            <button onclick="cerrarSesion()" class="btn-auth" style="background:var(--rojo); color:white">Cerrar Sesi칩n</button>
        </div>

        <div id="areaLogin">
            <p style="text-align:center; font-size:14px">Ingresa para gestionar tus ventas.</p>
            <input id="emailAuth" type="email" placeholder="Correo electr칩nico">
            <input id="passAuth" type="password" placeholder="Contrase침a">
            <div class="auth-box">
                <button onclick="manejarAuth('login')" class="btn-auth" style="background:var(--azul); color:white">ENTRAR A MI CUENTA</button>
                <button onclick="manejarAuth('registro')" class="btn-auth" style="background:var(--naranja); color:white">CREAR CUENTA NUEVA</button>
            </div>
            <span class="link-pass" onclick="recuperarClave()">쯆lvidaste tu contrase침a? Toca aqu칤</span>
        </div>
        
        <button onclick="cerrarPerfil()" style="background:none; border:none; color:var(--mut); margin-top:10px">Cerrar</button>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Nuevo Anuncio</h3>
        <input id="titulo" placeholder="쯈u칠 vendes?">
        <textarea id="descripcion" placeholder="Detalles del producto..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $" style="flex:1">
            <input id="cantidad" type="number" placeholder="Stock" value="1" style="width:60px">
        </div>
        <div class="subir-fotos-grid">
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="0" accept="image/*"><img id="p-0"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="1" accept="image/*"><img id="p-1"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="2" accept="image/*"><img id="p-2"><i class="fa-solid fa-camera"></i></div>
        </div>
        <select id="categoria"><option>Tecnolog칤a</option><option>Ropa</option><option>Comida</option><option>Otros</option></select>
        <select id="depto" onchange="actualizarMunicipios()"><option value="">Departamento</option></select>
        <select id="muni"><option value="">Municipio</option></select>
        <button id="btnPublicar" onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let MI_ID = null;
let editandoID = null;
let productos = [];
let fotosAnuncio = ["", "", ""];
let fotosVisorActual = [];
let indiceVisor = 0;

const svData = {
    "Ahuachap치n": ["Ahuachap치n", "Atiquizaya", "Jujutla"],
    "Santa Ana": ["Santa Ana", "Metap치n", "Chalchuapa"],
    "Sonsonate": ["Sonsonate", "Acajutla", "Izalco"],
    "San Salvador": ["San Salvador", "Mejicanos", "Soyapango", "Apopa"],
    "La Libertad": ["Santa Tecla", "Antiguo Cuscatl치n", "Col칩n"],
    "San Miguel": ["San Miguel", "Chinameca"],
    "Usulut치n": ["Usulut치n", "Jiquilisco"],
    "La Uni칩n": ["La Uni칩n", "Santa Rosa de Lima"]
};

// VIGILANTE DE SESI칍N
onAuthStateChanged(auth, async (user) => {
    if (user) {
        MI_ID = user.uid;
        document.getElementById('areaLogin').style.display = "none";
        document.getElementById('areaPerfilLogueado').style.display = "block";
        document.getElementById('txtSesion').textContent = "Conectado como: " + user.email;
        document.getElementById('bannerPerfil').style.display = "none";
        await cargarPerfil();
    } else {
        MI_ID = null;
        document.getElementById('areaLogin').style.display = "block";
        document.getElementById('areaPerfilLogueado').style.display = "none";
        document.getElementById('bannerPerfil').style.display = "block";
    }
    cargar();
});

// FUNCIONES DE ACCESO
window.manejarAuth = async (tipo) => {
    const email = document.getElementById('emailAuth').value;
    const pass = document.getElementById('passAuth').value;
    if(!email || !pass) return alert("Completa los campos.");
    try {
        if(tipo === 'login') {
            await signInWithEmailAndPassword(auth, email, pass);
        } else {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "vendedores", res.user.uid), { nombre: "Nuevo Chero", telefono: "", foto: "" });
        }
        cerrarPerfil();
    } catch (e) { alert("Error: " + e.message); }
};

window.recuperarClave = async () => {
    const email = document.getElementById('emailAuth').value;
    if(!email) return alert("Escribe tu correo arriba para enviarte el enlace.");
    try {
        await sendPasswordResetEmail(auth, email);
        alert("Enlace de recuperaci칩n enviado a tu correo.");
    } catch (e) { alert(e.message); }
};

window.cerrarSesion = () => { signOut(auth); cerrarPerfil(); };

// COMPRESI칍N DE FOTOS (3 FOTOS)
document.querySelectorAll('.foto-item').forEach(input => {
    input.onchange = e => {
        const file = e.target.files[0];
        const idx = e.target.dataset.idx;
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 600; canvas.height = 600;
                canvas.getContext('2d').drawImage(img, 0, 0, 600, 600);
                const b64 = canvas.toDataURL('image/jpeg', 0.6);
                fotosAnuncio[idx] = b64;
                const prev = document.getElementById(`p-${idx}`);
                prev.src = b64; prev.style.display = "block";
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
});

// PUBLICAR E INVENTARIO
window.abrir = () => { if(!MI_ID) return abrirPerfil(); editandoID = null; document.getElementById('modal').style.display = "block"; };
window.cerrar = () => document.getElementById('modal').style.display = "none";
window.abrirPerfil = () => document.getElementById('modalPerfil').style.display = "block";
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

window.publicar = async () => {
    const btn = document.getElementById('btnPublicar');
    const fFinales = fotosAnuncio.filter(f => f !== "");
    if (!document.getElementById('titulo').value || fFinales.length === 0) return alert("Faltan datos");

    btn.disabled = true; btn.textContent = "Procesando...";
    const datos = {
        titulo: document.getElementById('titulo').value,
        descripcion: document.getElementById('descripcion').value,
        precio: document.getElementById('precio').value,
        cantidad: document.getElementById('cantidad').value,
        fotos: fFinales,
        categoria: document.getElementById('categoria').value,
        depto: document.getElementById('depto').value,
        muni: document.getElementById('muni').value,
        vendedor: document.getElementById('perfilNombre').value,
        telefono: document.getElementById('perfilTelefono').value,
        duenoId: MI_ID,
        creado: Date.now(),
        vendido: false,
        oculto: false
    };

    if(editandoID) await updateDoc(doc(db, "productos", editandoID), datos);
    else await addDoc(collection(db, "productos"), datos);

    cerrar(); cargar();
    btn.disabled = false; btn.textContent = "Publicar Ahora";
};

// CARGA Y RENDER
async function cargar() {
    const snap = await getDocs(query(collection(db, "productos"), orderBy("creado", "desc")));
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = lista.map(p => `
        <div class="card">
            <img class="foto-principal" src="${p.fotos[0]}" onclick="verGaleria([${p.fotos.map(f=>`'${f}'`).join(',')}])">
            <div class="miniaturas-cont">
                ${p.fotos.map(f => `<img src="${f}" class="mini-foto" onclick="verGaleria([${p.fotos.map(f=>`'${f}'`).join(',')}])">`).join('')}
            </div>
            <div class="info">
                <div class="precio">$${p.precio}</div>
                <div class="titulo">${p.titulo}</div>
                <div class="tag-stock">${p.cantidad} disponibles</div>
                <div style="font-size:10px; color:var(--mut)">游늸 ${p.muni}</div>
                <a class="btn-wa" target="_blank" href="https://wa.me/503${p.telefono}?text=Me interesa ${p.titulo}"><i class="fa-brands fa-whatsapp"></i> Consultar</a>
                ${p.duenoId === MI_ID ? `<button onclick="eliminar('${p.id}')" style="color:red; border:none; background:none; margin-top:5px; font-size:11px">Eliminar Mi Anuncio</button>` : ''}
            </div>
        </div>
    `).join('');
}

// VISOR DE FOTOS L칍GICA
window.verGaleria = (fotos) => {
    fotosVisorActual = fotos;
    indiceVisor = 0;
    actualizarImagenVisor();
    document.getElementById('visorFotoInterno').style.display = 'flex';
};

function actualizarImagenVisor() {
    document.getElementById('fotoGrande').src = fotosVisorActual[indiceVisor];
}

window.cambiarFotoVisor = (dir) => {
    indiceVisor += dir;
    if(indiceVisor < 0) indiceVisor = fotosVisorActual.length - 1;
    if(indiceVisor >= fotosVisorActual.length) indiceVisor = 0;
    actualizarImagenVisor();
};

window.cerrarVisor = () => document.getElementById('visorFotoInterno').style.display = 'none';

// PERFIL VENDEDOR
async function cargarPerfil() {
    const snap = await getDoc(doc(db, "vendedores", MI_ID));
    if(snap.exists()) {
        const d = snap.data();
        document.getElementById('perfilNombre').value = d.nombre || "";
        document.getElementById('perfilTelefono').value = d.telefono || "";
        if(d.foto) document.getElementById('imgPerfilPrevia').src = d.foto;
    }
}

window.guardarPerfil = async () => {
    await setDoc(doc(db, "vendedores", MI_ID), {
        nombre: document.getElementById('perfilNombre').value,
        telefono: document.getElementById('perfilTelefono').value,
        foto: document.getElementById('imgPerfilPrevia').src
    }, {merge:true});
    alert("Datos actualizados");
};

// DEPARTAMENTOS
window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});

window.eliminar = async (id) => { if(confirm("쮼liminar este anuncio permanentemente?")) { await updateDoc(doc(db, "productos", id), {oculto:true}); cargar(); } };
</script>
</body>
</html>
