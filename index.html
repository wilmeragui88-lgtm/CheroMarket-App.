<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CheroMarketApp ¬∑ Pro</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://unpkg.com/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

<style>
:root{
--azul:#0047AB;--naranja:#FF8C00;--verde:#25D366;
--fondo:#f0f2f5;--card:#fff;--txt:#333;--mut:#777;--b:#ddd;--rojo:#c62828
}
[data-theme=dark]{
--fondo:#121212;--card:#1e1e1e;--txt:#eee;--mut:#aaa;--b:#333;--azul:#4c8cff
}
body{margin:0;font-family:Segoe UI;background:var(--fondo);color:var(--txt);padding-bottom:80px}
header{background:var(--card);border-bottom:3px solid var(--azul);padding:15px;text-align:center;position:sticky;top:0;z-index:9}
h1{margin:0;color:var(--azul)}
.sub{font-size:13px;color:var(--mut)}
.btn-menu{position:absolute;right:15px;top:20px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--azul)}
.sidebar{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--card);box-shadow:-2px 0 10px rgba(0,0,0,0.2);z-index:100;transition:0.3s;padding:20px;box-sizing:border-box;overflow-y:auto}
.sidebar.active{right:0}
.sidebar h2{color:var(--azul);font-size:18px;margin-top:0}
.sidebar-item{margin-bottom:20px;font-size:14px;line-height:1.4;border-bottom:1px solid var(--b);padding-bottom:10px}
.close-sidebar{background:var(--b);border:none;padding:8px;width:100%;border-radius:8px;cursor:pointer;margin-bottom:20px}
.buscador-cont{max-width:500px;margin:10px auto;display:flex;gap:8px;position:relative}
.buscador{flex:1;padding:12px;padding-left:40px;border-radius:25px;border:1px solid var(--b);background:var(--fondo)}
.search-icon{position:absolute;left:15px;top:15px;color:var(--mut)}
.btn-theme{width:40px;height:40px;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
.categorias{display:flex;gap:8px;overflow-x:auto;padding:10px;max-width:500px;margin:auto}
.cat{padding:8px 14px;border:none;border-radius:20px;font-weight:600;background:var(--b);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:5px}
.cat.active{background:var(--azul);color:white}
.feed{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;max-width:900px;margin:auto}
.card{background:var(--card);border-radius:12px;border:1px solid var(--b);overflow:hidden;display:flex;flex-direction:column;transition: 0.3s;position:relative}
.foto{height:180px;width:100%;object-fit:cover;background:#eee}
.info{padding:12px;display:flex;flex-direction:column;gap:5px;flex:1}
.tag-row{display:flex;gap:5px;flex-wrap:wrap}
.tag{font-size:10px;border:1px solid var(--azul);color:var(--azul);padding:2px 8px;border-radius:6px}
.tag-estado{background:var(--azul);color:white}
.tag-vendido{background:var(--rojo);color:white;border-color:var(--rojo)}
.titulo{font-weight:600;font-size:16px;margin-top:5px}
.precio{color:var(--naranja);font-size:20px;font-weight:700}
.desc{font-size:12px;color:var(--txt);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.mut{font-size:11px;color:var(--mut)}
.btn-wa{margin-top:auto;background:var(--verde);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-del{background:transparent;color:var(--rojo);border:none;padding:5px;font-size:11px;cursor:pointer;text-decoration:underline;margin-top:5px}
.btn-sold{background:var(--txt);color:var(--card);border:none;padding:8px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:bold}
.btn-add{position:fixed;bottom:20px;right:20px;width:65px;height:65px;border-radius:50%;background:var(--naranja);color:white;font-size:32px;border:none;box-shadow: 0 4px 10px rgba(0,0,0,0.3);z-index:10;cursor:pointer}
.btn-share{background:transparent;border:none;color:var(--azul);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:5px;padding:5px 0}
#modal, #modalPerfil{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:99;overflow-y:auto;padding:20px}
.modal-content{background:var(--card);max-width:500px;margin:auto;padding:20px;border-radius:15px;display:flex;flex-direction:column;gap:12px}
input,select,textarea{padding:12px;border-radius:8px;border:1px solid var(--b);background:var(--fondo);color:var(--txt);font-family:inherit}
textarea{resize:none;height:80px}
.sold-overlay{position:absolute;top:10px;right:10px;background:var(--rojo);color:white;padding:4px 10px;border-radius:4px;font-weight:bold;font-size:12px;z-index:1}
input[type="file"]{padding: 8px;border: 1px dashed var(--mut);border-radius: 8px;background: var(--card);cursor: pointer}
</style>
</head>

<body data-theme="light">

<header>
<button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
<h1>üá∏üáª CheroMarketApp</h1>
<div class="sub">Vende y compra en todo El Salvador</div>

<div class="buscador-cont">
<i class="fa-solid fa-magnifying-glass search-icon"></i>
<input id="buscar" class="buscador" placeholder="Buscar por nombre o lugar‚Ä¶" oninput="filtrar()">
<button class="btn-theme" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
</div>

<div class="categorias">
<button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
<button class="cat" onclick="setCat('Tecnolog√≠a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog√≠a</button>
<button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
<button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
<button class="cat" style="background:var(--naranja);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user"></i> Mi Perfil</button>
</div>
</header>

<div id="sidebar" class="sidebar">
<button class="close-sidebar" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i> Cerrar Men√∫</button>
<div class="sidebar-item">
<h2><i class="fa-solid fa-file-contract"></i> T√©rminos y Condiciones</h2>
<p>Al usar CheroMarketApp, aceptas que la plataforma solo facilita el contacto entre usuarios. No nos hacemos responsables por transacciones fallidas.</p>
</div>
<div class="sidebar-item">
<h2><i class="fa-solid fa-gavel"></i> Avisos Legales</h2>
<p>Queda prohibida la venta de art√≠culos il√≠citos. Cada usuario es responsable legalmente por lo que publica y vende.</p>
</div>
<div class="sidebar-item" style="color:var(--rojo)">
<h2><i class="fa-solid fa-shield-halved"></i> Gu√≠a Anti-Estafas</h2>
<p><strong>1.</strong> No env√≠es dinero por adelantado.<br>
<strong>2.</strong> Re√∫nete en lugares p√∫blicos y seguros.<br>
<strong>3.</strong> Revisa el producto antes de pagar.</p>
</div>
<div class="sidebar-item">
<p class="mut">Versi√≥n 1.3 Pro ¬∑ 2026 (con compresi√≥n de fotos)</p>
</div>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="modalPerfil">
<div class="modal-content">
<h3 style="margin:0"><i class="fa-solid fa-user-gear"></i> Configurar mi Perfil</h3>
<p class="mut">Estos datos aparecer√°n en tus anuncios para que te contacten.</p>
<input id="perfilNombre" placeholder="Tu nombre o negocio">
<input id="perfilTelefono" type="number" placeholder="Tu WhatsApp (ej: 77771234)">
<button type="button" onclick="guardarPerfil()" style="background:var(--verde);color:white;padding:15px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Guardar Cambios</button>
<button type="button" onclick="cerrarPerfil()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cerrar</button>
</div>
</div>

<div id="modal">
<div class="modal-content">
<h3 style="margin:0"><i class="fa-solid fa-tag"></i> Nuevo Anuncio</h3>
<input id="titulo" placeholder="¬øQu√© vendes?">
<textarea id="descripcion" placeholder="Describe tu producto (detalles, fallas, etc.)"></textarea>
<div style="display:flex;gap:10px">
<input id="precio" type="number" step="0.01" placeholder="Precio $" style="flex:1">
<select id="estado" style="flex:1">
<option value="Nuevo">Nuevo</option>
<option value="Usado">Usado</option>
</select>
</div>
<input type="file" id="fotoFile" accept="image/*" capture="environment">
<small class="mut">Sube foto desde c√°mara o galer√≠a (se comprime autom√°ticamente)</small>
<input id="fotoUrl" placeholder="O pega URL de imagen si no quieres subir archivo">
<select id="categoria">
<option>Tecnolog√≠a</option>
<option>Ropa</option>
<option>Comida</option>
<option>Otros</option>
</select>
<select id="depto" onchange="actualizarMunicipios()">
<option value="">Selecciona Departamento</option>
</select>
<select id="muni">
<option value="">Selecciona Municipio</option>
</select>
<button type="button" id="btnPublicar" onclick="publicar()" style="background:var(--azul);color:white;padding:15px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Publicar Ahora</button>
<button type="button" onclick="cerrar()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cancelar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
authDomain:"cheromarket.firebaseapp.com",
projectId:"cheromarket",
storageBucket:"cheromarket.firebasestorage.app",
messagingSenderId:"777368646513",
appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Men√∫
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');

// Perfil
if(!localStorage.getItem("mi_id_usuario")) localStorage.setItem("mi_id_usuario", "user_" + Math.random().toString(36).substr(2, 9));
const MI_ID = localStorage.getItem("mi_id_usuario");

const obtenerPerfil = () => ({
nombre: localStorage.getItem("perfil_nombre") || "Vendedor An√≥nimo",
telefono: localStorage.getItem("perfil_telefono") || "77771234"
});

window.abrirPerfil = () => {
const p = obtenerPerfil();
document.getElementById('perfilNombre').value = p.nombre==="Vendedor An√≥nimo"?"":p.nombre;
document.getElementById('perfilTelefono').value = p.telefono==="77771234"?"":p.telefono;
document.getElementById('modalPerfil').style.display="block";
};
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display="none";
window.guardarPerfil = () => {
const nom=document.getElementById('perfilNombre').value.trim();
const tel=document.getElementById('perfilTelefono').value.trim();
if(!nom||!tel) return alert("Por favor completa tu nombre y tel√©fono");
localStorage.setItem("perfil_nombre",nom);
localStorage.setItem("perfil_telefono",tel);
alert("Perfil actualizado correctamente");
cerrarPerfil();
};

// Ubicaciones SV
const svData = { /* tus datos de departamentos y municipios, se mantiene igual */ };
// Estado
const state = { categoria:"Todos" };
let productos=[];

function initUbicaciones(){
const deptoSelect=document.getElementById('depto');
Object.keys(svData).forEach(d=>{let opt=document.createElement('option');opt.value=d;opt.innerText=d;deptoSelect.appendChild(opt)});
}
window.actualizarMunicipios=()=>{const deptoVal=document.getElementById('depto').value;const muniSelect=document.getElementById('muni');muniSelect.innerHTML='<option value="">Selecciona Municipio</option>';if(deptoVal){svData[deptoVal].forEach(m=>{let opt=document.createElement('option');opt.value=m;opt.innerText=m;muniSelect.appendChild(opt);});}};

window.toggleTheme=()=>document.body.dataset.theme=document.body.dataset.theme==="dark"?"light":"dark";
window.abrir=()=>{document.getElementById('modal').style.display="block";document.getElementById('fotoFile').value="";document.getElementById('fotoUrl').value="";}
window.cerrar=()=>document.getElementById('modal').style.display="none";

// Publicar
window.publicar = async () => {
const titulo = document.getElementById('titulo');
const descripcion = document.getElementById('descripcion');
const precio = document.getElementById('precio');
const estado = document.getElementById('estado');
const categoria = document.getElementById('categoria');
const depto = document.getElementById('depto');
const muni = document.getElementById('muni');
const fotoFile = document.getElementById('fotoFile');
const fotoUrl = document.getElementById('fotoUrl');

if(!titulo.value.trim()||!precio.value.trim()||!depto.value||!muni.value) return alert("Completa los campos obligatorios");

const btn=document.getElementById('btnPublicar');btn.disabled=true;btn.innerText="Procesando...";

try{
const perfil=obtenerPerfil();
let imagenFinal=fotoUrl.value.trim()||"https://via.placeholder.com/400?text=Sin+Foto";

if(fotoFile.files && fotoFile.files.length>0){
const file=fotoFile.files[0];
const options={maxSizeMB:1,maxWidthOrHeight:1200,useWebWorker:true,fileType:'image/jpeg'};
const compressedFile=await imageCompression(file,options);
const storageRef=ref(storage,'productos/'+Date.now()+'_'+compressedFile.name);
await uploadBytes(storageRef,compressedFile);
imagenFinal=await getDownloadURL(storageRef);
}

await addDoc(collection(db,"productos"),{
titulo: titulo.value.trim(),
descripcion: descripcion.value.trim()||"Sin descripci√≥n adicional",
precio: parseFloat(precio.value),
estado: estado.value,
foto: imagenFinal,
categoria: categoria.value,
depto: depto.value,
muni: muni.value,
vendedor: perfil.nombre,
telefono: perfil.telefono,
creado: Date.now(),
duenoId: MI_ID,
vendido:false
});

// Limpiar formulario
titulo.value=""; descripcion.value=""; precio.value=""; fotoUrl.value=""; fotoFile.value="";
cerrar();
cargar();
alert("¬°Anuncio publicado con √©xito! üì∏");
}catch(error){console.error("Error al publicar:",error);alert("Hubo un error al publicar. Revisa la consola.");}finally{btn.disabled=false;btn.innerText="Publicar Ahora";}
};

// Cargar productos
async function cargar(){
productos=[];
const q=query(collection(db,"productos"),orderBy("creado","desc"));
const snap=await getDocs(q);
snap.forEach(docu=>{productos.push({id:docu.id,...docu.data()});});
renderFeed();
}

// Renderizar feed
function renderFeed(){
const feed=document.getElementById('feed');feed.innerHTML="";
let filtrarCat=state.categoria!=="Todos"?productos.filter(p=>p.categoria===state.categoria):productos;
const buscar=document.getElementById('buscar').value.trim().toLowerCase();
if(buscar){filtrarCat=filtrarCat.filter(p=>p.titulo.toLowerCase().includes(buscar)||p.depto.toLowerCase().includes(buscar)||p.muni.toLowerCase().includes(buscar));}
filtrarCat.forEach(p=>{
let c=document.createElement('div');c.className="card";
let soldOverlay=p.vendido?'<div class="sold-overlay">VENDIDO</div>':'';
c.innerHTML=`
<img src="${p.foto}" class="foto">
<div class="info">
<div class="titulo">${p.titulo}</div>
<div class="precio">$${p.precio.toFixed(2)}</div>
<div class="desc">${p.descripcion}</div>
<div class="tag-row">
<span class="tag tag-estado">${p.estado}</span>
<span class="tag">${p.categoria}</span>
<span class="tag">${p.depto} / ${p.muni}</span>
</div>
<a href="https://wa.me/503${p.telefono}?text=Hola,%20vi%20tu%20anuncio%20de%20${encodeURIComponent(p.titulo)}" target="_blank" class="btn-wa"><i class="fa-brands fa-whatsapp"></i> Contactar</a>
</div>
`;c.innerHTML+=soldOverlay;feed.appendChild(c);
});
}

// Filtros
window.setCat=(cat,el)=>{state.categoria=cat;document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));el.classList.add('active');renderFeed();}
window.filtrar=()=>renderFeed();

// Inicializar
initUbicaciones();
cargar();
</script>

</body>
</html>