<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CheroMarketApp ¬∑ Pro</title>

<style>
:root{
--azul:#0047AB;--naranja:#FF8C00;--verde:#25D366;
--fondo:#f0f2f5;--card:#fff;--txt:#333;--mut:#777;--b:#ddd
}
[data-theme=dark]{
--fondo:#121212;--card:#1e1e1e;--txt:#eee;--mut:#aaa;--b:#333;--azul:#4c8cff
}
body{margin:0;font-family:Segoe UI;background:var(--fondo);color:var(--txt);padding-bottom:80px}
header{background:var(--card);border-bottom:3px solid var(--azul);padding:15px;text-align:center;position:sticky;top:0;z-index:9}
h1{margin:0;color:var(--azul)}
.sub{font-size:13px;color:var(--mut)}
.buscador-cont{max-width:500px;margin:10px auto;display:flex;gap:8px}
.buscador{flex:1;padding:12px;border-radius:25px;border:1px solid var(--b);background:var(--fondo)}
.btn-theme{width:40px;height:40px;border:none;border-radius:50%;cursor:pointer}
.categorias{display:flex;gap:8px;overflow-x:auto;padding:10px;max-width:500px;margin:auto}
.cat{padding:8px 14px;border:none;border-radius:20px;font-weight:600;background:var(--b);cursor:pointer;white-space:nowrap}
.cat.active{background:var(--azul);color:white}
.feed{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;max-width:900px;margin:auto}
.card{background:var(--card);border-radius:12px;border:1px solid var(--b);overflow:hidden;display:flex;flex-direction:column;transition: 0.3s}
.foto{height:180px;width:100%;object-fit:cover;background:#eee}
.info{padding:12px;display:flex;flex-direction:column;gap:5px;flex:1}
.tag-row{display:flex;gap:5px;flex-wrap:wrap}
.tag{font-size:10px;border:1px solid var(--azul);color:var(--azul);padding:2px 8px;border-radius:6px}
.tag-estado{background:var(--azul);color:white}
.titulo{font-weight:600;font-size:16px;margin-top:5px}
.precio{color:var(--naranja);font-size:20px;font-weight:700}
.desc{font-size:12px;color:var(--txt);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.mut{font-size:11px;color:var(--mut)}
.btn-wa{margin-top:auto;background:var(--verde);color:white;text-decoration:none;text-align:center;padding:10px;border-radius:8px;font-weight:600}
.btn-del{background:transparent;color:#c62828;border:none;padding:5px;font-size:11px;cursor:pointer;text-decoration:underline;margin-top:5px}
.btn-add{position:fixed;bottom:20px;right:20px;width:65px;height:65px;border-radius:50%;background:var(--naranja);color:white;font-size:32px;border:none;box-shadow: 0 4px 10px rgba(0,0,0,0.3);z-index:10}
#modal, #modalPerfil{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:99;overflow-y:auto;padding:20px}
.modal-content{background:var(--card);max-width:500px;margin:auto;padding:20px;border-radius:15px;display:flex;flex-direction:column;gap:12px}
input,select,textarea{padding:12px;border-radius:8px;border:1px solid var(--b);background:var(--fondo);color:var(--txt);font-family:inherit}
textarea{resize:none;height:80px}
</style>
</head>

<body data-theme="light">

<header>
<h1>üá∏üáª CheroMarketApp</h1>
<div class="sub">Vende y compra en todo El Salvador</div>

<div class="buscador-cont">
<input id="buscar" class="buscador" placeholder="Buscar por nombre o lugar‚Ä¶" oninput="filtrar()">
<button class="btn-theme" onclick="toggleTheme()">üåì</button>
</div>

<div class="categorias">
<button class="cat active" onclick="setCat('Todos',this)">Todos</button>
<button class="cat" onclick="setCat('Tecnolog√≠a',this)">Tecnolog√≠a</button>
<button class="cat" onclick="setCat('Ropa',this)">Ropa</button>
<button class="cat" onclick="setCat('Comida',this)">Comida</button>
<button class="cat" style="background:var(--naranja);color:white" onclick="abrirPerfil()">üë§ Mi Perfil</button>
</div>
</header>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()">+</button>

<div id="modalPerfil">
    <div class="modal-content">
        <h3 style="margin:0">Configurar mi Perfil</h3>
        <p class="mut">Estos datos aparecer√°n en tus anuncios para que te contacten.</p>
        <input id="perfilNombre" placeholder="Tu nombre o negocio">
        <input id="perfilTelefono" type="number" placeholder="Tu WhatsApp (ej: 77771234)">
        <button type="button" onclick="guardarPerfil()" style="background:var(--verde);color:white;padding:15px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Guardar Cambios</button>
        <button type="button" onclick="cerrarPerfil()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cerrar</button>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3 style="margin:0">Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes?">
        <textarea id="descripcion" placeholder="Describe tu producto (detalles, fallas, etc.)"></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" step="0.01" placeholder="Precio $" style="flex:1">
            <select id="estado" style="flex:1">
                <option value="Nuevo">Nuevo</option>
                <option value="Usado">Usado</option>
            </select>
        </div>
        <input id="fotoUrl" placeholder="URL de la imagen (ej: https://...)">
        <select id="categoria">
            <option>Tecnolog√≠a</option>
            <option>Ropa</option>
            <option>Comida</option>
            <option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()">
            <option value="">Selecciona Departamento</option>
        </select>
        <select id="muni">
            <option value="">Selecciona Municipio</option>
        </select>
        <button type="button" onclick="publicar()" style="background:var(--azul);color:white;padding:15px;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Publicar Ahora</button>
        <button type="button" onclick="cerrar()" style="background:transparent;color:var(--mut);border:none;cursor:pointer">Cancelar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
authDomain:"cheromarket.firebaseapp.com",
projectId:"cheromarket",
storageBucket:"cheromarket.firebasestorage.app",
messagingSenderId:"777368646513",
appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- L√ìGICA DE IDENTIDAD Y PERFIL ---
if(!localStorage.getItem("mi_id_usuario")) {
    localStorage.setItem("mi_id_usuario", "user_" + Math.random().toString(36).substr(2, 9));
}
const MI_ID = localStorage.getItem("mi_id_usuario");

// Cargar datos de perfil guardados
const obtenerPerfil = () => ({
    nombre: localStorage.getItem("perfil_nombre") || "Vendedor An√≥nimo",
    telefono: localStorage.getItem("perfil_telefono") || "77771234"
});

window.abrirPerfil = () => {
    const p = obtenerPerfil();
    document.getElementById('perfilNombre').value = p.nombre === "Vendedor An√≥nimo" ? "" : p.nombre;
    document.getElementById('perfilTelefono').value = p.telefono === "77771234" ? "" : p.telefono;
    document.getElementById('modalPerfil').style.display = "block";
};

window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

window.guardarPerfil = () => {
    const nom = document.getElementById('perfilNombre').value.trim();
    const tel = document.getElementById('perfilTelefono').value.trim();
    if(!nom || !tel) return alert("Por favor completa tu nombre y tel√©fono");
    localStorage.setItem("perfil_nombre", nom);
    localStorage.setItem("perfil_telefono", tel);
    alert("Perfil actualizado correctamente");
    cerrarPerfil();
};
// -----------------------

const svData = {
"Ahuachap√°n": ["Ahuachap√°n", "Jujutla", "Atiquizaya", "Concepci√≥n de Ataco", "El Refugio", "Guaymango", "Apaneca", "San Francisco Men√©ndez", "San Lorenzo", "San Pedro Puxtla", "Tur√≠n"],
"Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Metap√°n", "San Antonio Pajonal", "San Sebasti√°n Salitrillo", "Santa Rosa Guachipil√≠n", "Santiago de la Frontera", "Texistepeque"],
"Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juay√∫a", "Nahuizalco", "Nahulingo", "Salcoatit√°n", "San Antonio del Monte", "San Juli√°n", "Santa Catarina Masahuat", "Santa Isabel Ishuat√°n", "Santo Domingo de Guzm√°n", "Sonzacate"],
"Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "Cital√°", "Comalapa", "Concepci√≥n Quezaltepeque", "Dulce Nombre de Mar√≠a", "El Carrizal", "El Para√≠so", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de Jes√∫s", "Nueva Concepci√≥n", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Moraz√°n", "San Ignacio", "San Isidro Labrador", "San Jos√© Cancasque", "San Jos√© Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
"La Libertad": ["Santa Tecla", "Antiguo Cuscatl√°n", "Chiltiup√°n", "Ciudad Arce", "Col√≥n", "Comasagua", "Huiz√∫car", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatl√°n", "Quezaltepeque", "San Juan Opico", "Sacacoyo", "San Jos√© Villanueva", "San Mat√≠as", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
"San Salvador": ["San Salvador", "Ayutuxtepeque", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Mart√≠n", "Santiago Texacuangos", "Santo Tom√°s", "Soyapango", "Tonacatepeque", "Delgado", "Cuscatancingo", "Ilopango", "Guazapa", "Aguilares", "El Paisnal"],
"Cuscatl√°n": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepci√≥n", "San Bartolom√© Perulap√≠a", "San Crist√≥bal", "San Jos√© Guayabal", "San Rafael Cedros", "San Ram√≥n", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo", "San Pedro Perulap√°n"],
"La Paz": ["Zacatecoluca", "Cuyultit√°n", "El Rosario", "Jerusal√©n", "Mercedes La Ceiba", "Olocuilta", "Para√≠so de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Marcelino", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa Mar√≠a Ostuma", "Santiago Nonualco", "Tapalhuac√°n"],
"Caba√±as": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Victoria"],
"San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebasti√°n", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetit√°n", "Verapaz"],
"Usulut√°n": ["Usulut√°n", "Alegr√≠a", "Berl√≠n", "California", "Concepci√≥n Batres", "El Triunfo", "Ereguayqu√≠n", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuar√°n", "Mercedes Uma√±a", "Nueva Granada", "Ozatl√°n", "Puerto El Triunfo", "San Agust√≠n", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa Mar√≠a", "Santiago de Mar√≠a", "Tecap√°n"],
"San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacar√°n", "Gualococti", "Guatajiagua", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Ed√©n de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],
"Moraz√°n": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepci√≥n", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Loloquique", "Meanguera", "Osicala", "Perqu√≠n", "San Carlos", "San Fernando", "San Isidro", "San Sim√≥n", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiqu√≠n"],
"La Uni√≥n": ["La Uni√≥n", "Conchagua", "El Carmen", "Intipuc√°", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polor√≥s", "San Alejo", "San Jos√©", "Santa Rosa de Lima", "Yayantique", "Yucuaiqu√≠n", "Lislique", "Anamor√≥s", "Concepci√≥n de Oriente", "El Sauce"]
};

const state = { categoria:"Todos" };

function initUbicaciones() {
    const deptoSelect = document.getElementById('depto');
    Object.keys(svData).forEach(d => {
        let opt = document.createElement('option');
        opt.value = d; opt.innerText = d;
        deptoSelect.appendChild(opt);
    });
}

window.actualizarMunicipios = () => {
    const deptoVal = document.getElementById('depto').value;
    const muniSelect = document.getElementById('muni');
    muniSelect.innerHTML = '<option value="">Selecciona Municipio</option>';
    if(deptoVal) {
        svData[deptoVal].forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            muniSelect.appendChild(opt);
        });
    }
};

window.toggleTheme=()=>document.body.dataset.theme=
document.body.dataset.theme==="dark"?"light":"dark";

window.abrir=()=>modal.style.display="block";
window.cerrar=()=>modal.style.display="none";

window.publicar = async () => {
    if(!titulo.value || !precio.value || !depto.value || !muni.value) return alert("Completa los campos obligatorios");
    
    const perfil = obtenerPerfil();
    const imagenFinal = fotoUrl.value || "https://via.placeholder.com/400?text=Sin+Foto";

    await addDoc(collection(db,"productos"),{
        titulo: titulo.value,
        descripcion: descripcion.value || "Sin descripci√≥n adicional",
        precio: Number(precio.value).toFixed(2),
        estado: estado.value,
        foto: imagenFinal,
        categoria: categoria.value,
        depto: depto.value,
        muni: muni.value,
        vendedor: perfil.nombre,
        telefono: perfil.telefono,
        creado: Date.now(),
        duenoId: MI_ID
    });
    
    titulo.value = ""; descripcion.value = ""; precio.value = ""; fotoUrl.value = "";
    cerrar();
    cargar();
};

window.eliminar = async id => {
    if(confirm("¬øEliminar este anuncio permanentemente?")){
        await deleteDoc(doc(db,"productos",id));
        cargar();
    }
};

window.setCat=(c,b)=>{
    state.categoria=c;
    document.querySelectorAll(".cat").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

window.filtrar=()=>{
    const t=buscar.value.toLowerCase();
    document.querySelectorAll(".card").forEach(c=>{
        c.style.display=
        (c.dataset.t.includes(t) || c.dataset.l.includes(t)) &&
        (state.categoria==="Todos"||c.dataset.c===state.categoria)
        ?"flex":"none";
    });
};

async function cargar(){
    const q=query(collection(db,"productos"),orderBy("creado","desc"));
    const snap=await getDocs(q);
    render(snap.docs.map(d=>({id:d.id,...d.data()})));
}

function render(lista){
    feed.innerHTML="";
    lista.forEach(p=>{
        const botonEliminar = (p.duenoId === MI_ID) 
            ? `<button class="btn-del" onclick="eliminar('${p.id}')">Marcar como Vendido / Eliminar</button>` 
            : '';

        feed.innerHTML+=`
        <div class="card" data-t="${p.titulo.toLowerCase()}" data-l="${p.muni.toLowerCase()}" data-c="${p.categoria}">
            <img class="foto" src="${p.foto}" alt="producto">
            <div class="info">
                <div class="tag-row">
                    <span class="tag">${p.categoria}</span>
                    <span class="tag tag-estado">${p.estado}</span>
                </div>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="desc">${p.descripcion}</div>
                <div class="mut">üìç ${p.muni}, ${p.depto} <br>üë§ ${p.vendedor}</div>
                <a class="btn-wa" target="_blank"
                href="https://wa.me/503${p.telefono}?text=Hola! Me interesa el producto: ${p.titulo} ($${p.precio}) que vi en CheroMarket.">
                Contactar</a>
                ${botonEliminar}
            </div>
        </div>`;
    });
}

initUbicaciones();
cargar();

// --- LO QUE AGREGO: Solo usuarios registrados pueden publicar ---
const publicarOriginal = window.publicar;
window.publicar = async () => {
    const p = obtenerPerfil();
    if (p.nombre === "Vendedor An√≥nimo" || !localStorage.getItem("perfil_nombre")) {
        alert("¬°Atenci√≥n! Solo usuarios registrados pueden publicar. Por favor, completa tu perfil primero.");
        cerrar(); 
        abrirPerfil();
        return;
    }
    await publicarOriginal();
};
// ----------------------------------------------------------------
</script>

</body>
</html>
