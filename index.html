<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp ¬∑ Pro üá∏üáª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; position: sticky; top: 0; z-index: 10;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}
        .cat-fav{background: #ffeaa7 !important; color: #d63031 !important;}

        .perfil-img-cont{text-align:center; position:relative; width:80px; margin:auto}
        .foto-perfil{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); background:#eee; cursor:pointer}
        .header-catalogo{grid-column: 1 / -1; background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--azul); margin-bottom: 10px;}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative; transition: 0.2s;}
        .foto-principal{height:160px; width:100%; object-fit:cover; background:#eee; cursor: pointer;}
        
        .miniaturas-cont{display: flex; gap: 4px; padding: 6px; background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--b);}
        .mini-foto{width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid var(--b); cursor: pointer;}

        .btn-fav {position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--mut);}
        .btn-fav.active {color: #ff4757;}
        .btn-share-post {position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--azul);}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tags-cont{display:flex; gap:4px; flex-wrap:wrap; margin-bottom:4px}
        .tag{font-size:9px; border:1px solid var(--azul); color:var(--azul); padding:1px 6px; border-radius:4px; font-weight: bold;}
        .tag-envio{font-size:9px; background:var(--azul); color:white; padding:1px 6px; border-radius:4px; font-weight: bold;}
        .tag-stock{font-size:10px; color:var(--verde); font-weight:bold; margin-top:2px}
        
        .titulo{font-weight:600; font-size:15px; line-height: 1.2; margin-top: 4px;}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .loc{font-size:10px; color:var(--mut); margin-top: 5px;}
        .vendedor-link {font-size: 11px; color: var(--azul); text-decoration: underline; cursor: pointer; margin-top: 5px; display: flex; align-items: center; gap: 4px;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-vendido-accion{background:var(--azul); color:white; border:none; padding:8px; border-radius:8px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:8px}
        .btn-eliminar-accion{background:none; color:var(--rojo); border:none; padding:5px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:5px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        
        #modal, #modalPerfil{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:99; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--fondo); color:var(--txt); font-family:inherit}
        
        #visorFotoInterno{position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; display:none; justify-content:center; align-items:center; flex-direction:column}
        #fotoGrande{max-width:95%; max-height:80%; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5)}
        .btn-cerrar-visor{position:absolute; top:30px; right:20px; color:white; font-size:30px; cursor:pointer; background:none; border:none}

        .subir-fotos-grid{display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px;}
        .foto-input-box{border: 2px dashed var(--azul); border-radius: 8px; height: 80px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--fondo);}
        .foto-input-box input{opacity: 0; position: absolute; inset: 0; z-index: 2; cursor: pointer;}
        .foto-input-box img{width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: 1; display:none}

        .sidebar{position:fixed; top:0; right:-280px; width:280px; height:100%; background:var(--card); box-shadow:-5px 0 15px rgba(0,0,0,0.3); z-index:100; transition:0.3s; padding:20px; box-sizing:border-box}
        .sidebar.active{right:0}
        .btn-menu{position:absolute; right:15px; top:18px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--azul)}
        .seccion-titulo{grid-column: 1 / -1; font-size: 14px; font-weight: bold; color: var(--mut); margin-top: 15px; border-bottom: 1px solid var(--b); padding-bottom: 5px;}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    ‚ö†Ô∏è <strong>Perfil Incompleto:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; text-decoration: underline;">Configura tu perfil</a> para vender.
</div>

<header>
    <button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div class="sub">Compra y vende entre salvadore√±os</div>

    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="¬øQu√© buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M√°x" oninput="filtrar()">
        <button class="btn-theme" style="background:none; border:none; cursor:pointer; color:var(--azul)" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()">
            <option value="">üìç Todo El Salvador</option>
        </select>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
        <button class="cat cat-fav" onclick="verFavoritos(this)"><i class="fa-solid fa-heart"></i> Favoritos</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user-circle"></i> Mi Perfil</button>
    </div>
</header>
     
<div id="sidebar" class="sidebar">
    <button style="width:100%; padding:10px; margin-bottom:20px" onclick="toggleMenu()">Cerrar Men√∫</button>
    <p>CheroMarketApp Versi√≥n 2.0 Pro ¬∑ 2026</p>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="visorFotoInterno" onclick="cerrarVisor()">
    <button class="btn-cerrar-visor"><i class="fa-solid fa-xmark"></i></button>
    <img id="fotoGrande" src="" onclick="event.stopPropagation()">
</div>

<div id="modal">
    <div class="modal-content">
        <h3>Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes?">
        <textarea id="descripcion" placeholder="Detalles del producto..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $" style="flex:1">
            <input id="cantidad" type="number" placeholder="Stock" value="1" style="width: 50px; text-align: center;">
            <select id="estado" style="flex:1">
                <option value="Nuevo">Nuevo</option>
                <option value="Usado">Usado</option>
            </select>
        </div>
        <select id="opcionEnvio">
            <option value="Solo entrega local">Solo entrega local</option>
            <option value="Env√≠os a todo el pa√≠s">Env√≠os a todo el pa√≠s</option>
        </select>
        <div class="subir-fotos-grid">
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="0" accept="image/*"><img id="p-0"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="1" accept="image/*"><img id="p-1"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="2" accept="image/*"><img id="p-2"><i class="fa-solid fa-camera"></i></div>
        </div>
        <select id="categoria">
            <option>Tecnolog√≠a</option><option>Ropa</option><option>Comida</option><option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()"><option value="">Departamento</option></select>
        <select id="muni"><option value="">Municipio</option></select>
        <button onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil de Vendedor</h3>
        <div class="perfil-img-cont" onclick="document.getElementById('fotoPerfilFile').click()">
            <img id="imgPerfilPrevia" class="foto-perfil" src="https://via.placeholder.com/80">
            <input type="file" id="fotoPerfilFile" accept="image/*" style="display:none">
        </div>
        <input id="perfilNombre" placeholder="Tu nombre o negocio">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77771234)">
        <button onclick="iniciarSesion()" style="background:#4285F4; color:white; padding:10px; border:none; border-radius:8px; margin-bottom:10px">
            <i class="fa-brands fa-google"></i> Vincular con Google
        </button>
        <button onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Guardar Perfil</button>
        <button onclick="verMisAnuncios()" style="background:var(--azul); color:white; padding:10px; border:none; border-radius:8px;">Mis Anuncios</button>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none">Cerrar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let usuarioActual = null;
let productos = [];
let favoritos = JSON.parse(localStorage.getItem("mis_favoritos")) || [];
let fotosAnuncio = ["", "", ""];
let fotoPerfilBase64 = localStorage.getItem("p_foto") || "";
const state = { categoria: "Todos" };
const MI_ID = localStorage.getItem("mi_id_usuario") || "u_" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("mi_id_usuario", MI_ID);

const svData = {
"Ahuachap√°n": ["Ahuachap√°n", "Atiquizaya", "Jujutla"],
"Santa Ana": ["Santa Ana", "Chalchuapa", "Metap√°n"],
"San Salvador": ["San Salvador", "Mejicanos", "Soyapango", "Santa Tecla"],
"La Libertad": ["Santa Tecla", "Antiguo Cuscatl√°n", "Col√≥n"]
};

// Funciones globales para que los botones las vean
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
window.abrir = () => !verificarPerfil() ? abrirPerfil() : document.getElementById('modal').style.display = "block";
window.cerrar = () => {
    document.getElementById('modal').style.display = "none";
    fotosAnuncio = ["", "", ""];
    document.querySelectorAll('.foto-input-box img').forEach(i => i.style.display="none");
};
window.abrirPerfil = () => {
    document.getElementById('perfilNombre').value = localStorage.getItem("p_nombre") || "";
    document.getElementById('perfilTelefono').value = localStorage.getItem("p_tel") || "";
    document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64 || "https://via.placeholder.com/80";
    document.getElementById('modalPerfil').style.display = "block";
};
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";
window.verImagenFull = (src) => {
    document.getElementById('fotoGrande').src = src;
    document.getElementById('visorFotoInterno').style.display = 'flex';
};
window.cerrarVisor = () => document.getElementById('visorFotoInterno').style.display = 'none';

window.iniciarSesion = async () => {
    try {
        await signInWithPopup(auth, provider);
        alert("¬°Cuenta vinculada!");
    } catch (e) { alert("Error: " + e.message); }
};

window.guardarPerfil = async () => {
    const nombre = document.getElementById('perfilNombre').value;
    const tel = document.getElementById('perfilTelefono').value;
    if (!nombre || !tel) return alert("Faltan datos");

    localStorage.setItem("p_nombre", nombre);
    localStorage.setItem("p_tel", tel);
    localStorage.setItem("p_foto", fotoPerfilBase64);

    if (usuarioActual) {
        await setDoc(doc(db, "usuarios", usuarioActual.uid), { nombre, tel, foto: fotoPerfilBase64 });
    }
    verificarPerfil();
    cerrarPerfil();
};

window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

window.publicar = async () => {
    if (!usuarioActual) return alert("Primero vincula tu cuenta con Google en el Perfil");
    const t = document.getElementById('titulo').value, p = document.getElementById('precio').value;
    const fotosFinales = fotosAnuncio.filter(f => f !== "");
    if(!t || !p || fotosFinales.length === 0) return alert("Faltan datos o fotos");

    await addDoc(collection(db,"productos"), {
        titulo: t,
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2),
        cantidad: parseInt(document.getElementById('cantidad').value) || 1,
        fotos: fotosFinales,
        categoria: document.getElementById('categoria').value,
        entrega: document.getElementById('opcionEnvio').value,
        depto: document.getElementById('depto').value,
        muni: document.getElementById('muni').value,
        vendedor: localStorage.getItem("p_nombre"),
        telefono: localStorage.getItem("p_tel"),
        creado: Date.now(),
        duenoId: usuarioActual.uid,
        vendido: false,
        oculto: false
    });
    location.reload();
};

window.filtrar = () => {
    const txt = document.getElementById('buscar').value.toLowerCase();
    const pMax = parseFloat(document.getElementById('precioMax').value) || Infinity;
    const filtrados = productos.filter(p => {
        const cTxt = p.titulo.toLowerCase().includes(txt);
        const cCat = state.categoria === "Todos" ? true : p.categoria === state.categoria;
        return cTxt && cCat && parseFloat(p.precio) <= pMax;
    });
    render(filtrados);
};

window.setCat = (c, b) => {
    state.categoria = c;
    document.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    lista.forEach(p => {
        const fotos = p.fotos || [];
        feed.innerHTML += `
        <div class="card">
            <img class="foto-principal" src="${fotos[0] || ''}" onclick="verImagenFull(this.src)">
            <div class="info">
                <span class="tag">${p.categoria}</span>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="loc">${p.muni}, ${p.depto}</div>
                <a class="btn-wa" href="https://wa.me/503${p.telefono}"><i class="fa-brands fa-whatsapp"></i> Preguntar</a>
            </div>
        </div>`;
    });
}

function verificarPerfil() {
    const n = localStorage.getItem("p_nombre"), t = localStorage.getItem("p_tel");
    document.getElementById("bannerPerfil").style.display = (n && t) ? "none" : "block";
    return (n && t);
}

// Manejo de fotos
document.querySelectorAll('.foto-item').forEach(input => {
    input.onchange = e => {
        const file = e.target.files[0];
        const idx = e.target.dataset.idx;
        const reader = new FileReader();
        reader.onload = ev => {
            fotosAnuncio[idx] = ev.target.result;
            const prev = document.getElementById(`p-${idx}`);
            prev.src = ev.target.result; prev.style.display = "block";
        };
        reader.readAsDataURL(file);
    };
});

document.getElementById('fotoPerfilFile').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        fotoPerfilBase64 = ev.target.result;
        document.getElementById('imgPerfilPrevia').src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

onAuthStateChanged(auth, async (user) => {
    if (user) {
        usuarioActual = user;
        const docSnap = await getDoc(doc(db, "usuarios", user.uid));
        if (docSnap.exists()) {
            const d = docSnap.data();
            localStorage.setItem("p_nombre", d.nombre);
            localStorage.setItem("p_tel", d.tel);
            fotoPerfilBase64 = d.foto || "";
        }
    }
    verificarPerfil();
    cargar();
});

const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});
</script>
</body>
</html>
