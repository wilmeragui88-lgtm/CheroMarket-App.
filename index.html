<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp ¬∑ Pro üá∏üáª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0047AB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CheroMarket">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:9}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none; position: sticky; top: 0; z-index: 10;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt)}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}
        .cat-fav{background: #ffeaa7 !important; color: #d63031 !important;}

        .perfil-img-cont{text-align:center; position:relative; width:80px; margin:auto}
        .foto-perfil{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); background:#eee; cursor:pointer}
        
        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative;}
        .foto-principal{height:160px; width:100%; object-fit:cover; background:#eee; cursor: pointer;}
        
        .miniaturas-cont{display: flex; gap: 4px; padding: 6px; background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--b);}
        .mini-foto{width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid var(--b); cursor: pointer;}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tag{font-size:9px; border:1px solid var(--azul); color:var(--azul); padding:1px 6px; border-radius:4px; font-weight: bold; width: fit-content;}
        .titulo{font-weight:600; font-size:15px; line-height: 1.2; margin-top: 4px;}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .tag-stock{font-size:10px; color:var(--verde); font-weight:bold;}
        .loc{font-size:10px; color:var(--mut); margin-top: 5px;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-vendido-accion{background:var(--azul); color:white; border:none; padding:8px; border-radius:8px; font-size:11px; font-weight:bold; cursor:pointer; margin-top:8px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:10; cursor:pointer}
        
        #modal, #modalPerfil{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:99; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--fondo); color:var(--txt); font-family:inherit}
        
        /* Barra de carga */
        .loading-bar-cont { width: 100%; background: #eee; height: 10px; border-radius: 5px; overflow: hidden; display: none; margin-bottom: 10px; }
        .loading-bar-fill { width: 0%; height: 100%; background: var(--azul); transition: width 0.3s; }

        .sidebar{position:fixed; top:0; right:-280px; width:280px; height:100%; background:var(--card); box-shadow:-5px 0 15px rgba(0,0,0,0.3); z-index:100; transition:0.3s; padding:20px; box-sizing:border-box; overflow-y: auto;}
        .sidebar.active{right:0}
        .btn-menu{position:absolute; right:15px; top:18px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--azul)}
        .sold-overlay{position:absolute; top:0; left:0; width:100%; height:160px; background:rgba(0,0,0,0.7); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:1}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    ‚ö†Ô∏è <strong>Acceso Restringido:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404;">Configura tu perfil</a> para vender.
</div>

<header>
    <button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div class="sub">Compra y vende entre salvadore√±os</div>

    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="¬øQu√© buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M√°x" oninput="filtrar()">
        <button style="background:none; border:none; cursor:pointer; color:var(--azul)" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()">
            <option value="">üìç Todo El Salvador</option>
        </select>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user-circle"></i> Perfil</button>
    </div>
</header>

<div id="sidebar" class="sidebar">
    <button style="width:100%; padding:10px; margin-bottom:20px" onclick="toggleMenu()">Cerrar Men√∫</button>
    <div style="background: var(--card); border:1px solid var(--b); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <h4 style="margin-top:0">üìú T√©rminos y Seguridad</h4>
        <p style="font-size:12px; color:var(--mut)">Acepta para continuar usando la plataforma.</p>
        <div id="contAceptarTerminos">
            <button id="btnAceptarTerminos" onclick="confirmarTerminos()" style="width: 100%; padding: 12px; background: var(--verde); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                Acepto los T√©rminos
            </button>
        </div>
    </div>
    <p style="font-size: 11px; text-align: center; color: var(--mut);">CheroMarketApp v2.6 Pro</p>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes?">
        <textarea id="descripcion" placeholder="Detalles del producto..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $">
            <input id="cantidad" type="number" placeholder="Stock" value="1" style="width: 60px;">
        </div>
        <div class="subir-fotos-grid">
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="0" accept="image/*"><img id="p-0"></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="1" accept="image/*"><img id="p-1"></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="2" accept="image/*"><img id="p-2"></div>
        </div>
        <select id="categoria">
            <option>Tecnolog√≠a</option><option>Ropa</option><option>Comida</option><option>Otros</option>
        </select>
        <select id="depto" onchange="actualizarMunicipios()"><option value="">Departamento</option></select>
        <select id="muni"><option value="">Municipio</option></select>
        
        <div id="loaderCont" class="loading-bar-cont">
            <div id="loaderFill" class="loading-bar-fill"></div>
        </div>

        <button id="btnPublicar" onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil</h3>
        <div class="perfil-img-cont" onclick="document.getElementById('fotoPerfilFile').click()">
            <img id="imgPerfilPrevia" class="foto-perfil" src="https://via.placeholder.com/80">
            <input type="file" id="fotoPerfilFile" accept="image/*" style="display:none">
        </div>
        <input id="perfilNombre" placeholder="Nombre Comercial">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (sin 503)">
        <button onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold">Guardar Perfil</button>
        <hr>
        <input id="emailVincular" type="email" placeholder="Email">
        <input id="passwordVincular" type="password" placeholder="Clave">
        <button id="btnVincular" style="background:var(--naranja); color:white; padding:12px; border:none; border-radius:8px;">Ingresar</button>
        <button id="btnCerrarSesion" style="background:var(--rojo); color:white; padding:10px; border:none; border-radius:8px; display:none" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none">Cerrar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let MI_ID = null;
let editandoID = null;
let productos = [];
let fotosAnuncio = ["", "", ""];
let fotoPerfilBase64 = "";

const svData = {
    "Santa Ana": ["Santa Ana", "Metap√°n", "Chalchuapa"],
    "San Salvador": ["San Salvador", "Mejicanos", "Soyapango"],
    "San Vicente": ["San Vicente", "Apastepeque"],
    "San Miguel": ["San Miguel", "Chinameca"]
};

onAuthStateChanged(auth, async (user) => {
    if (user) {
        MI_ID = user.uid;
        document.getElementById('btnCerrarSesion').style.display = "block";
        await cargarPerfil();
    } else {
        MI_ID = null;
        document.getElementById('bannerPerfil').style.display = "block";
    }
    await cargar();
});

// FUNCI√ìN PARA ACEPTAR T√âRMINOS Y CERRAR SIDEBAR AUTOM√ÅTICAMENTE
window.confirmarTerminos = () => {
    localStorage.setItem("terminos_aceptados", "true");
    verificarEstadoTerminos();
    toggleMenu(); // ESTO CIERRA EL SIDEBAR AUTOM√ÅTICAMENTE
};

function verificarEstadoTerminos() {
    if (localStorage.getItem("terminos_aceptados") === "true") {
        const c = document.getElementById('contAceptarTerminos');
        if(c) c.innerHTML = "<p style='color:var(--verde); font-weight:bold; font-size:12px;'>‚úÖ Aceptado</p>";
    }
}
window.addEventListener('load', verificarEstadoTerminos);

window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";

window.abrir = () => {
    if (!MI_ID) { alert("Inicia sesi√≥n."); abrirPerfil(); }
    else {
        editandoID = null;
        limpiarCampos();
        document.getElementById('modal').style.display = "block";
    }
};

window.cerrar = () => document.getElementById('modal').style.display = "none";

function limpiarCampos() {
    document.getElementById('titulo').value = "";
    document.getElementById('precio').value = "";
    fotosAnuncio = ["", "", ""];
    document.querySelectorAll('.foto-input-box img').forEach(i => i.style.display="none");
}

window.abrirEditar = (id) => {
    const p = productos.find(item => item.id === id);
    if (!p) return;
    editandoID = id;
    document.getElementById('modalTitulo').textContent = "Editar Anuncio";
    document.getElementById('titulo').value = p.titulo;
    document.getElementById('precio').value = p.precio;
    document.getElementById('depto').value = p.depto;
    actualizarMunicipios();
    document.getElementById('muni').value = p.muni;
    document.getElementById('modal').style.display = "block";
};

window.publicar = async () => {
    const btn = document.getElementById('btnPublicar');
    const loader = document.getElementById('loaderCont');
    const bar = document.getElementById('loaderFill');

    const t = document.getElementById('titulo').value.trim();
    const p = document.getElementById('precio').value;
    const dep = document.getElementById('depto').value;
    const mun = document.getElementById('muni').value;
    const fotosFinales = fotosAnuncio.filter(f => f !== "");

    if (!t || !p || !dep || !mun || fotosFinales.length === 0) return alert("Faltan datos.");

    try {
        btn.disabled = true;
        btn.textContent = "Subiendo...";
        loader.style.display = "block";
        bar.style.width = "40%";

        const datos = {
            titulo: t,
            descripcion: document.getElementById('descripcion').value,
            precio: parseFloat(p).toFixed(2),
            cantidad: parseInt(document.getElementById('cantidad').value) || 1,
            fotos: fotosFinales,
            categoria: document.getElementById('categoria').value,
            depto: dep,
            muni: mun,
            vendido: false,
            actualizado: Date.now()
        };

        bar.style.width = "75%";

        if (editandoID) {
            await updateDoc(doc(db, "productos", editandoID), datos);
        } else {
            await addDoc(collection(db, "productos"), {
                ...datos,
                vendedor: document.getElementById('perfilNombre').value,
                telefono: document.getElementById('perfilTelefono').value,
                fotoPerfilVendedor: fotoPerfilBase64,
                creado: Date.now(),
                duenoId: MI_ID,
                oculto: false
            });
        }

        bar.style.width = "100%";
        setTimeout(() => {
            alert("‚úÖ Guardado!");
            cerrar();
            cargar();
            loader.style.display = "none";
        }, 500);

    } catch (e) { alert("Error: " + e.message); }
    finally { btn.disabled = false; btn.textContent = "Publicar Ahora"; }
};

window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    feed.innerHTML = lista.map(p => `
        <div class="card">
            ${p.vendido ? '<div class="sold-overlay">AGOTADO</div>' : ''}
            <img class="foto-principal" src="${p.fotos[0]}">
            <div class="info">
                <div class="tag">${p.categoria}</div>
                <div class="titulo">${p.titulo}</div>
                <div class="precio">$${p.precio}</div>
                <div class="loc">${p.muni}, ${p.depto}</div>
                <a class="btn-wa" href="https://wa.me/503${p.telefono}" target="_blank">WhatsApp</a>
                ${p.duenoId === MI_ID ? `<button class="btn-vendido-accion" onclick="abrirEditar('${p.id}')">Editar</button>` : ''}
            </div>
        </div>`).join('');
}

document.querySelectorAll('.foto-item').forEach(input => {
    input.onchange = e => {
        const file = e.target.files[0];
        const idx = e.target.dataset.idx;
        const reader = new FileReader();
        reader.onload = ev => {
            fotosAnuncio[idx] = ev.target.result;
            const img = document.getElementById(`p-${idx}`);
            img.src = ev.target.result; img.style.display = "block";
        };
        reader.readAsDataURL(file);
    };
});

window.abrirPerfil = () => document.getElementById('modalPerfil').style.display = "block";
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

async function cargarPerfil() {
    const snap = await getDoc(doc(db, "vendedores", MI_ID));
    if (snap.exists()) {
        const p = snap.data();
        document.getElementById('perfilNombre').value = p.nombre || "";
        document.getElementById('perfilTelefono').value = p.telefono || "";
        fotoPerfilBase64 = p.foto || "";
        document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64 || "https://via.placeholder.com/80";
        document.getElementById('bannerPerfil').style.display = "none";
    }
}

window.guardarPerfil = async () => {
    await setDoc(doc(db, "vendedores", MI_ID), {
        nombre: document.getElementById('perfilNombre').value,
        telefono: document.getElementById('perfilTelefono').value,
        foto: fotoPerfilBase64
    }, { merge: true });
    alert("Perfil OK.");
    document.getElementById('bannerPerfil').style.display = "none";
};

const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});

document.getElementById('btnVincular').onclick = async () => {
    const e = document.getElementById('emailVincular').value;
    const p = document.getElementById('passwordVincular').value;
    try { await signInWithEmailAndPassword(auth, e, p); } catch { await createUserWithEmailAndPassword(auth, e, p); }
    cerrarPerfil();
};

window.cerrarSesion = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
