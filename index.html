<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheroMarketApp ¬∑ Pro üá∏üáª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0047AB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CheroMarket">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root{
            --azul:#0047AB; --naranja:#FF8C00; --verde:#25D366;
            --fondo:#f0f2f5; --card:#fff; --txt:#333; --mut:#777; --b:#ddd; --rojo:#c62828;
            --warning: #e67e22;
        }
        [data-theme=dark]{
            --fondo:#121212; --card:#1e1e1e; --txt:#eee; --mut:#aaa; --b:#333; --azul:#4c8cff
        }
        body{margin:0; font-family:'Segoe UI', system-ui, -apple-system, sans-serif; background:var(--fondo); color:var(--txt); padding-bottom:80px}
        header{background:var(--card); border-bottom:3px solid var(--azul); padding:15px; text-align:center; position:sticky; top:0; z-index:99}
        h1{margin:0; color:var(--azul); font-size: 22px;}
        .sub{font-size:12px; color:var(--mut); margin-bottom: 10px;}

        .alerta-perfil{background: #fff3cd; color: #856404; padding: 12px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; display: none;}

        .buscador-cont{max-width:500px; margin:10px auto; display:flex; gap:8px; position:relative; padding: 0 10px;}
        .buscador{flex:1; padding:12px 12px 12px 35px; border-radius:25px; border:1px solid var(--b); background:var(--fondo); color: var(--txt); font-size: 16px;}
        .search-icon{position:absolute; left:22px; top:15px; color:var(--mut)}
        .input-precio{width: 80px; padding: 12px; border-radius: 25px; border: 1px solid var(--b); background: var(--fondo); color: var(--txt); text-align: center;}
        
        .filtro-depto-cont{max-width:500px; margin: 5px auto; padding: 0 10px;}
        #filtroDepto{width:100%; padding: 10px; border-radius: 12px; border: 1px solid var(--azul); background: var(--card); color: var(--azul); font-weight: bold; cursor: pointer;}

        .categorias{display:flex; gap:8px; overflow-x:auto; padding:10px; max-width:500px; margin:auto; scrollbar-width: none;}
        .cat{padding:8px 14px; border:none; border-radius:20px; font-weight:600; background:var(--b); color: var(--txt); cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px}
        .cat.active{background:var(--azul); color:white}
        .cat-fav{background: #ffeaa7 !important; color: #d63031 !important;}

        .perfil-img-cont{text-align:center; position:relative; width:80px; margin:10px auto}
        .foto-perfil{width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--azul); background:#eee; cursor:pointer}
        .header-catalogo{grid-column: 1 / -1; background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--azul); margin-bottom: 10px;}

        .feed{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:12px; max-width:900px; margin:auto}
        .card{background:var(--card); border-radius:12px; border:1px solid var(--b); overflow:hidden; display:flex; flex-direction:column; position:relative; transition: transform 0.2s;}
        .card:active{transform: scale(0.98);}
        .foto-principal{height:160px; width:100%; object-fit:cover; background:#eee; cursor: pointer;}
        
        .miniaturas-cont{display: flex; gap: 4px; padding: 6px; background: rgba(0,0,0,0.03); border-bottom: 1px solid var(--b); overflow-x: auto;}
        .mini-foto{width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid var(--b); cursor: pointer; flex-shrink: 0;}

        .btn-fav {position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--mut); box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        .btn-fav.active {color: #ff4757;}
        .btn-share-post {position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; color: var(--azul); box-shadow: 0 2px 5px rgba(0,0,0,0.2);}

        .info{padding:10px; display:flex; flex-direction:column; gap:4px; flex:1}
        .tags-cont{display:flex; gap:4px; flex-wrap:wrap; margin-bottom:4px}
        .tag{font-size:9px; border:1px solid var(--azul); color:var(--azul); padding:1px 6px; border-radius:4px; font-weight: bold;}
        .tag-envio{font-size:9px; background:var(--azul); color:white; padding:1px 6px; border-radius:4px; font-weight: bold;}
        .tag-stock{font-size:10px; font-weight:bold; margin-top:2px}
        
        .titulo{font-weight:600; font-size:15px; line-height: 1.2; margin-top: 4px; color: var(--txt)}
        .precio{color:var(--naranja); font-size:18px; font-weight:800}
        .loc{font-size:10px; color:var(--mut); margin-top: 5px;}
        .vendedor-link {font-size: 11px; color: var(--azul); text-decoration: underline; cursor: pointer; margin-top: 5px; display: flex; align-items: center; gap: 4px;}

        .btn-wa{margin-top:auto; background:var(--verde); color:white; text-decoration:none; text-align:center; padding:10px; border-radius:8px; font-weight:700; font-size: 13px; display:flex; align-items:center; justify-content:center; gap:5px}
        .btn-add{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--naranja); color:white; font-size:28px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index:100; cursor:pointer}
        
        #modal, #modalPerfil{position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:1000; overflow-y:auto; padding:20px}
        .modal-content{background:var(--card); max-width:450px; margin:auto; padding:20px; border-radius:15px; display:flex; flex-direction:column; gap:12px}
        input, select, textarea{padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--fondo); color:var(--txt); font-family:inherit; font-size: 14px;}
        
        #visorFotoInterno{position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; display:none; justify-content:center; align-items:center; flex-direction:column}
        #fotoGrande{max-width:95%; max-height:80%; border-radius:10px; object-fit: contain;}
        .btn-cerrar-visor{position:absolute; top:30px; right:20px; color:white; font-size:30px; cursor:pointer; background:none; border:none}

        .subir-fotos-grid{display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px;}
        .foto-input-box{border: 2px dashed var(--azul); border-radius: 8px; height: 80px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--fondo);}
        .foto-input-box input{opacity: 0; position: absolute; inset: 0; z-index: 2; cursor: pointer;}
        .foto-input-box img{width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: 1; display:none}

        .sidebar{position:fixed; top:0; right:-300px; width:280px; height:100%; background:var(--card); box-shadow:-5px 0 15px rgba(0,0,0,0.3); z-index:1000; transition:0.3s; padding:20px; box-sizing:border-box; overflow-y: auto;}
        .sidebar.active{right:0}
        .btn-menu{position:absolute; left:15px; top:18px; background:none; border:none; font-size:22px; cursor:pointer; color:var(--azul)}
        .sold-overlay{position:absolute; top:0; left:0; width:100%; height:160px; background:rgba(0,0,0,0.7); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:1; font-size: 20px;}
        .seccion-titulo{grid-column: 1 / -1; font-size: 14px; font-weight: bold; color: var(--mut); margin-top: 15px; border-bottom: 1px solid var(--b); padding-bottom: 5px;}
    </style>
</head>
<body data-theme="light">

<div id="bannerPerfil" class="alerta-perfil">
    ‚ö†Ô∏è <strong>Acceso Restringido:</strong> <a href="#" onclick="abrirPerfil()" style="color:#856404; text-decoration: underline;">Inicia sesi√≥n</a> para vender en el Market.
</div>

<header>
    <button class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    <h1>üá∏üáª CheroMarketApp</h1>
    <div class="sub">Compra y vende entre salvadore√±os</div>

    <div class="buscador-cont">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input id="buscar" class="buscador" placeholder="¬øQu√© buscas?" oninput="filtrar()">
        <input id="precioMax" class="input-precio" type="number" placeholder="$ M√°x" oninput="filtrar()">
        <button class="btn-theme" style="background:none; border:none; cursor:pointer; color:var(--azul)" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="filtro-depto-cont">
        <select id="filtroDepto" onchange="filtrar()">
            <option value="">üìç Todo El Salvador</option>
        </select>
    </div>

    <div class="categorias">
        <button class="cat active" onclick="setCat('Todos',this)"><i class="fa-solid fa-border-all"></i> Todos</button>
        <button class="cat" onclick="setCat('Tecnolog√≠a',this)"><i class="fa-solid fa-laptop"></i> Tecnolog√≠a</button>
        <button class="cat" onclick="setCat('Ropa',this)"><i class="fa-solid fa-shirt"></i> Ropa</button>
        <button class="cat" onclick="setCat('Comida',this)"><i class="fa-solid fa-utensils"></i> Comida</button>
        <button class="cat cat-fav" onclick="verFavoritos(this)"><i class="fa-solid fa-heart"></i> Favoritos</button>
        <button class="cat" style="background:var(--azul);color:white" onclick="abrirPerfil()"><i class="fa-solid fa-user-circle"></i> Mi Perfil</button>
    </div>
</header>

<div id="sidebar" class="sidebar">
    <button style="width:100%; padding:10px; margin-bottom:20px; border-radius: 8px; border: 1px solid var(--b);" onclick="toggleMenu()">Cerrar Men√∫</button>
    <div style="font-family: inherit; border: 1px solid var(--b); border-radius: 12px; overflow: hidden; background: var(--card);">
  
        <div style="max-height: 400px; overflow-y: auto;">
            <details style="border-bottom: 1px solid var(--b);" open>
            <summary style="padding: 15px; cursor: pointer; font-weight: bold; background: var(--fondo);">üìú T√©rminos</summary>
            <div style="padding: 15px; font-size: 13px; line-height: 1.5;">
                <p>CheroMarketApp es un intermediario. No nos hacemos responsables por tratos fallidos. Siempre revisa el producto antes de pagar.</p>
                <p>Prohibido: Armas, drogas, art√≠culos robados o ilegales en El Salvador.</p>
            </div>
            </details>

            <details style="border-bottom: 1px solid var(--b);">
            <summary style="padding: 15px; cursor: pointer; font-weight: bold; background: var(--fondo);">üõ°Ô∏è Gu√≠a de Seguridad</summary>
            <div style="padding: 15px; font-size: 13px; background: #fffde7; color: #333">
                <strong>Recomendaciones:</strong>
                <ul>
                    <li>Puntos p√∫blicos (Metrocentro, Multiplaza, gasolineras).</li>
                    <li>No env√≠es dinero por adelantado (ni para el bus).</li>
                    <li>Verifica billetes y transferencias en el momento.</li>
                </ul>
            </div>
            </details>
        </div>

        <div style="padding: 15px; text-align: center;">
            <button onclick="alert('¬°Gracias por ser un buen chero!')" style="width: 100%; padding: 12px; background: var(--verde); color: white; border: none; border-radius: 8px; font-weight: bold;">Acepto los t√©rminos</button>
            <p style="font-size: 10px; margin-top: 10px; color: var(--mut)">Versi√≥n 2.0 Pro ¬∑ 2026</p>
        </div>
    </div>
</div>

<div id="feed" class="feed"></div>
<button class="btn-add" onclick="abrir()"><i class="fa-solid fa-plus"></i></button>

<div id="visorFotoInterno" onclick="cerrarVisor()">
    <button class="btn-cerrar-visor"><i class="fa-solid fa-xmark"></i></button>
    <img id="fotoGrande" src="" alt="Imagen ampliada" onclick="event.stopPropagation()">
</div>

<div id="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Nuevo Anuncio</h3>
        <input id="titulo" placeholder="¬øQu√© vendes? (ej: iPhone 15 Pro)">
        <textarea id="descripcion" rows="3" placeholder="Detalles, estado del producto, fallas si tiene..."></textarea>
        <div style="display:flex;gap:10px">
            <input id="precio" type="number" placeholder="Precio $" style="flex:1">
            <input id="cantidad" type="number" placeholder="Stock" value="1" style="width: 70px; text-align: center;">
        </div>
        <select id="categoria">
            <option>Tecnolog√≠a</option><option>Ropa</option><option>Comida</option><option>Hogar</option><option>Veh√≠culos</option><option>Otros</option>
        </select>
        <select id="opcionEnvio">
            <option value="Solo entrega local">Punto de encuentro (Local)</option>
            <option value="Env√≠os a todo el pa√≠s">Env√≠os a todo el pa√≠s üöö</option>
        </select>
        <div class="subir-fotos-grid">
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="0" accept="image/*"><img id="p-0" alt="F1"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="1" accept="image/*"><img id="p-1" alt="F2"><i class="fa-solid fa-camera"></i></div>
            <div class="foto-input-box"><input type="file" class="foto-item" data-idx="2" accept="image/*"><img id="p-2" alt="F3"><i class="fa-solid fa-camera"></i></div>
        </div>
        <div style="display:flex; gap:10px">
            <select id="depto" onchange="actualizarMunicipios()" style="flex:1"><option value="">Depto.</option></select>
            <select id="muni" style="flex:1"><option value="">Municipio</option></select>
        </div>
        <button id="btnPublicar" onclick="publicar()" style="background:var(--azul); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor: pointer;">Publicar Ahora</button>
        <button onclick="cerrar()" style="background:none; color:var(--mut); border:none; cursor: pointer;">Cancelar</button>
    </div>
</div>

<div id="modalPerfil">
    <div class="modal-content">
        <h3>Mi Perfil de Vendedor</h3>
        <div class="perfil-img-cont" onclick="document.getElementById('fotoPerfilFile').click()">
            <img id="imgPerfilPrevia" class="foto-perfil" src="https://via.placeholder.com/80" alt="Perfil">
            <input type="file" id="fotoPerfilFile" accept="image/*" style="display:none">
        </div>
        <input id="perfilNombre" placeholder="Nombre o Nombre de tu Negocio">
        <input id="perfilTelefono" type="number" placeholder="WhatsApp (ej: 77771234)">
        <button onclick="guardarPerfil()" style="background:var(--verde); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor: pointer;">Actualizar Datos</button>
        
        <div id="seccionLogueado" style="display:none">
            <button onclick="verMisAnuncios()" style="background:var(--azul); color:white; width: 100%; padding:10px; border:none; border-radius:8px; margin-top: 10px;">Gestionar Mis Anuncios</button>
            <button style="background:var(--rojo); color:white; width: 100%; padding:10px; border:none; border-radius:8px; margin-top:5px;" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>

        <div id="seccionLogin">
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--b);">
            <h4 style="text-align:center; color:var(--mut); margin: 0 0 10px 0;">Acceso Seguro</h4>
            <input id="emailVincular" type="email" placeholder="Tu correo electr√≥nico">
            <input id="passwordVincular" type="password" placeholder="Contrase√±a (m√≠nimo 6 caracteres)">
            <button id="btnVincular" style="background:var(--naranja); color:white; width: 100%; padding:12px; border:none; border-radius:8px; font-weight:bold; margin-top:10px; cursor: pointer;">
              Entrar / Crear Cuenta
            </button>
        </div>
        
        <div id="msgVincular" style="font-size:13px; text-align:center; margin-top:8px;"></div>
        <button onclick="cerrarPerfil()" style="background:none; color:var(--mut); border:none; cursor: pointer; margin-top: 10px;">Cerrar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, query, orderBy, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey:"AIzaSyD-QOvro2aOC8GpPfnQWkBxZCWIR3lypdI",
    authDomain:"cheromarket.firebaseapp.com",
    projectId:"cheromarket",
    storageBucket:"cheromarket.firebasestorage.app",
    messagingSenderId:"777368646513",
    appId:"1:777368646513:web:42b49dad96c2dcf76b7cd0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let MI_ID = null;
let editandoID = null;
let productos = [];
let favoritos = JSON.parse(localStorage.getItem("mis_favoritos")) || [];
const state = { categoria: "Todos" };

const svData = {
    "Ahuachap√°n": ["Ahuachap√°n", "Atiquizaya", "Concepci√≥n de Ataco", "Apaneca", "San Francisco Men√©ndez"],
    "Santa Ana": ["Santa Ana", "Chalchuapa", "Metap√°n", "Coatepeque", "San Sebasti√°n Salitrillo"],
    "Sonsonate": ["Sonsonate", "Acajutla", "Izalco", "Juay√∫a", "Nahuizalco"],
    "Chalatenango": ["Chalatenango", "La Palma", "Nueva Concepci√≥n", "San Ignacio"],
    "La Libertad": ["Santa Tecla", "Antiguo Cuscatl√°n", "Col√≥n", "Lourdes", "Zaragoza", "Puerto de La Libertad"],
    "San Salvador": ["San Salvador", "Mejicanos", "Soyapango", "Ilopango", "Santa Tecla", "Apopa", "San Marcos", "Delgado"],
    "Cuscatl√°n": ["Cojutepeque", "Suchitoto", "San Pedro Perulap√°n"],
    "La Paz": ["Zacatecoluca", "Olocuilta", "San Luis Talpa"],
    "Caba√±as": ["Sensuntepeque", "Ilobasco"],
    "San Vicente": ["San Vicente", "Apastepeque"],
    "Usulut√°n": ["Usulut√°n", "Santiago de Mar√≠a", "Jiquilisco"],
    "San Miguel": ["San Miguel", "Chinameca", "Ciudad Barrios"],
    "Moraz√°n": ["San Francisco Gotera", "Perqu√≠n"],
    "La Uni√≥n": ["La Uni√≥n", "Santa Rosa de Lima", "Conchagua"]
};

// --- Utilidades ---
const normalizar = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

onAuthStateChanged(auth, async (user) => {
  if (user) {
    MI_ID = user.uid;
    document.getElementById('seccionLogin').style.display = "none";
    document.getElementById('seccionLogueado').style.display = "block";
    await cargarPerfil();
  } else {
    MI_ID = null;
    document.getElementById('seccionLogin').style.display = "block";
    document.getElementById('seccionLogueado').style.display = "none";
    document.getElementById('bannerPerfil').style.display = "block";
  }
  await cargar();
});

window.cerrarSesion = () => { if(confirm("¬øCerrar sesi√≥n?")) signOut(auth).then(()=>location.reload()); };

// --- Im√°genes ---
let fotosAnuncio = ["", "", ""];
let fotoPerfilBase64 = "";

document.querySelectorAll('.foto-item').forEach(input => {
    input.onchange = e => {
        const file = e.target.files[0];
        const idx = e.target.dataset.idx;
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 800; 
                let w = img.width, h = img.height;
                if (w > MAX) { h *= MAX/w; w = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                const b64 = canvas.toDataURL('image/jpeg', 0.5);
                fotosAnuncio[idx] = b64;
                const prev = document.getElementById(`p-${idx}`);
                prev.src = b64; prev.style.display = "block";
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
});

document.getElementById('fotoPerfilFile').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 150; canvas.height = 150;
            canvas.getContext('2d').drawImage(img, 0, 0, 150, 150);
            fotoPerfilBase64 = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64;
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
};

// --- L√≥gica Principal ---
window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";

window.abrir = () => {
    if (!MI_ID) { alert("Inicia sesi√≥n para vender."); return abrirPerfil(); }
    if (!document.getElementById('perfilTelefono').value) { alert("Completa tu perfil primero."); return abrirPerfil(); }
    editandoID = null;
    limpiarCampos();
    document.getElementById('modal').style.display = "block";
};

window.cerrar = () => document.getElementById('modal').style.display = "none";

function limpiarCampos() {
    document.getElementById('titulo').value = "";
    document.getElementById('descripcion').value = "";
    document.getElementById('precio').value = "";
    document.getElementById('cantidad').value = "1";
    fotosAnuncio = ["", "", ""];
    document.querySelectorAll('.foto-input-box img').forEach(i => i.style.display="none");
}

window.abrirEditar = (id) => {
    const p = productos.find(item => item.id === id);
    if (!p) return;
    editandoID = id;
    document.getElementById('modalTitulo').textContent = "Editar Anuncio";
    document.getElementById('titulo').value = p.titulo;
    document.getElementById('precio').value = p.precio;
    document.getElementById('cantidad').value = p.cantidad || 1;
    document.getElementById('categoria').value = p.categoria;
    document.getElementById('depto').value = p.depto;
    actualizarMunicipios();
    document.getElementById('muni').value = p.muni;
    document.getElementById('modal').style.display = "block";
};

async function cargarPerfil() {
    const docRef = doc(db, "vendedores", MI_ID);
    const snap = await getDoc(docRef);
    if (snap.exists()) {
        const d = snap.data();
        document.getElementById('perfilNombre').value = d.nombre || "";
        document.getElementById('perfilTelefono').value = d.telefono || "";
        fotoPerfilBase64 = d.foto || "";
        document.getElementById('imgPerfilPrevia').src = fotoPerfilBase64 || "https://via.placeholder.com/80";
        document.getElementById('bannerPerfil').style.display = "none";
    }
}

window.guardarPerfil = async () => {
    const tel = document.getElementById('perfilTelefono').value;
    if (!/^[267]\d{7}$/.test(tel)) return alert("WhatsApp inv√°lido (8 d√≠gitos, empieza con 2, 6 o 7)");
    
    try {
        await setDoc(doc(db, "vendedores", MI_ID), {
            nombre: document.getElementById('perfilNombre').value,
            telefono: tel,
            foto: fotoPerfilBase64
        }, { merge: true });
        alert("¬°Perfil guardado!");
        document.getElementById('bannerPerfil').style.display = "none";
    } catch(e) { alert(e.message); }
};

window.publicar = async () => {
    const btn = document.getElementById('btnPublicar');
    const t = document.getElementById('titulo').value.trim();
    const p = document.getElementById('precio').value;
    const cant = parseInt(document.getElementById('cantidad').value) || 0;
    const fotosFinales = fotosAnuncio.filter(f => f !== "");
    const dep = document.getElementById('depto').value;

    if (!t || !p || fotosFinales.length === 0 || !dep) return alert("Faltan datos o fotos.");

    btn.disabled = true;
    btn.textContent = "Publicando...";

    const datos = {
        titulo: t,
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(p).toFixed(2),
        cantidad: cant,
        fotos: fotosFinales,
        categoria: document.getElementById('categoria').value,
        entrega: document.getElementById('opcionEnvio').value,
        depto: dep,
        muni: document.getElementById('muni').value,
        vendido: cant <= 0,
        creado: Date.now(),
        duenoId: MI_ID,
        vendedor: document.getElementById('perfilNombre').value,
        telefono: document.getElementById('perfilTelefono').value,
        fotoPerfilVendedor: fotoPerfilBase64,
        oculto: false
    };

    try {
        if (editandoID) {
            await updateDoc(doc(db, "productos", editandoID), datos);
        } else {
            await addDoc(collection(db, "productos"), datos);
        }
        location.reload();
    } catch(e) { alert(e.message); btn.disabled = false; }
};

// --- Render y Filtros ---
window.filtrar = () => {
    const busquedaRaw = document.getElementById('buscar').value;
    const busqueda = normalizar(busquedaRaw);
    const dep = document.getElementById('filtroDepto').value;
    const pMax = parseFloat(document.getElementById('precioMax').value) || Infinity;

    const filtrados = productos.filter(p => {
        const matchTxt = normalizar(p.titulo).includes(busqueda) || normalizar(p.categoria).includes(busqueda);
        const matchDep = dep === "" || p.depto === dep;
        const matchPre = parseFloat(p.precio) <= pMax;
        const matchCat = state.categoria === "Todos" ? true : (state.categoria === "Favoritos" ? favoritos.includes(p.id) : p.categoria === state.categoria);
        return matchTxt && matchDep && matchPre && matchCat;
    });
    render(filtrados);
};

window.setCat = (c, b) => {
    state.categoria = c;
    document.querySelectorAll(".cat").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    filtrar();
};

async function cargar() {
    const q = query(collection(db, "productos"), orderBy("creado", "desc"));
    const snap = await getDocs(q);
    productos = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.oculto);
    render(productos);
}

function render(lista) {
    const feed = document.getElementById('feed');
    const disp = lista.filter(p => !p.vendido);
    const vend = lista.filter(p => p.vendido);
    
    let html = disp.map(p => crearCard(p)).join('');
    if (vend.length) {
        html += `<div class="seccion-titulo">VENDIDOS / AGOTADOS</div>`;
        html += vend.map(p => crearCard(p)).join('');
    }
    feed.innerHTML = html || '<p style="text-align:center;width:100%">No se encontraron productos.</p>';
}

function crearCard(p) {
    const esFav = favoritos.includes(p.id);
    const esMio = p.duenoId === MI_ID;
    const stock = p.cantidad || 0;
    const colorStock = stock < 3 ? 'var(--rojo)' : (stock < 6 ? 'var(--warning)' : 'var(--verde)');

    return `
    <div class="card" style="${p.vendido ? 'opacity:0.7' : ''}">
        ${p.vendido ? '<div class="sold-overlay">VENDIDO</div>' : ''}
        <button class="btn-fav ${esFav?'active':''}" onclick="toggleFavorito('${p.id}')"><i class="fa-solid fa-heart"></i></button>
        <img class="foto-principal" src="${p.fotos[0]}" onclick="verImagenFull('${p.fotos[0]}')">
        <div class="info">
            <div class="tags-cont">
                <span class="tag">${p.categoria}</span>
                <span class="tag-envio">${p.entrega === 'Env√≠os a todo el pa√≠s' ? 'üöö Env√≠o' : 'ü§ù Punto'}</span>
            </div>
            <div class="titulo">${p.titulo}</div>
            <div class="precio">$${p.precio}</div>
            <div class="tag-stock" style="color:${colorStock}">${p.vendido ? 'Agotado' : stock + ' disponibles'}</div>
            <div class="loc">üìç ${p.muni}, ${p.depto}</div>
            
            ${!p.vendido ? `
            <a class="btn-wa" href="https://wa.me/503${p.telefono}?text=Hola, me interesa el ${p.titulo} que vi en CheroMarket" target="_blank">
                <i class="fa-brands fa-whatsapp"></i> Preguntar
            </a>` : ''}

            ${esMio ? `
            <div style="display:flex; gap:5px; margin-top:5px">
                <button onclick="abrirEditar('${p.id}')" style="flex:1; padding:5px; font-size:10px">Editar</button>
                <button onclick="eliminarAnuncio('${p.id}')" style="flex:1; padding:5px; font-size:10px; color:var(--rojo)">Borrar</button>
            </div>` : ''}
        </div>
    </div>`;
}

// --- Eventos Interfaz ---
window.actualizarMunicipios = () => {
    const d = document.getElementById('depto').value;
    const m = document.getElementById('muni');
    m.innerHTML = '<option value="">Municipio</option>';
    if(svData[d]) svData[d].forEach(mun => m.innerHTML += `<option value="${mun}">${mun}</option>`);
};

window.verImagenFull = (src) => {
    document.getElementById('fotoGrande').src = src;
    document.getElementById('visorFotoInterno').style.display = 'flex';
};
window.cerrarVisor = () => document.getElementById('visorFotoInterno').style.display = 'none';

window.abrirPerfil = () => document.getElementById('modalPerfil').style.display = "block";
window.cerrarPerfil = () => document.getElementById('modalPerfil').style.display = "none";

window.toggleFavorito = (id) => {
    favoritos.includes(id) ? favoritos = favoritos.filter(f => f !== id) : favoritos.push(id);
    localStorage.setItem("mis_favoritos", JSON.stringify(favoritos));
    filtrar();
};

window.eliminarAnuncio = async (id) => {
    if(confirm("¬øBorrar este anuncio?")) {
        await updateDoc(doc(db, "productos", id), { oculto: true });
        location.reload();
    }
};

// --- Registro/Login ---
document.getElementById('btnVincular').onclick = async () => {
    const email = document.getElementById('emailVincular').value;
    const pass = document.getElementById('passwordVincular').value;
    const msg = document.getElementById('msgVincular');
    try {
        await signInWithEmailAndPassword(auth, email, pass);
        location.reload();
    } catch {
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            alert("Cuenta creada con √©xito.");
            location.reload();
        } catch(e) { msg.innerText = e.message; msg.style.color = "red"; }
    }
};

// Llenar selectores
const dSelect = document.getElementById('depto');
const fDepto = document.getElementById('filtroDepto');
Object.keys(svData).forEach(d => {
    dSelect.innerHTML += `<option value="${d}">${d}</option>`;
    fDepto.innerHTML += `<option value="${d}">${d}</option>`;
});
</script>
</body>
</html>
